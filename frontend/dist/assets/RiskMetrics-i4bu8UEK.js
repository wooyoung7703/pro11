import{j as Z,k as p,c as y,d as tt,x as et,m as nt,a as u,b as t,f as M,A as o,p as J,i as V,q as st,C as Q,v as lt,t as i,n as F,B as X,F as ot,r as it,e as d}from"./index-BtrOmqR2.js";import Y from"./http-CilSfrpq.js";import{c as at}from"./sse-Bs9vxAPf.js";import{_ as rt}from"./_plugin-vue_export-helper-DlAUqK2U.js";const H={},ut=Z("risk",()=>{const r=p(null),c=p([]),S=p(!1),g=p(null),q=p(null),f=p("idle"),h=p(null),x=p(!0),m=p(10);let k=null,v=null;const _=p([]),E=240,L=y(()=>{if(!r.value)return null;const s=r.value.peak_equity,n=r.value.current_equity;return s<=0?0:(s-n)/s}),A=y(()=>{var s;return((s=r.value)==null?void 0:s.cumulative_pnl)??null}),P=y(()=>{if(!r.value)return null;const s=r.value.starting_equity;if(!s||s<=0)return null;let n=0;for(const e of c.value){const a=Math.abs(e.size*e.entry_price);isFinite(a)&&(n+=a)}return n/s}),I=y(()=>{const s=_.value;if(s.length<2)return"";const n=100,e=30,a=Math.min(...s),l=Math.max(...s)-a||1;return s.map((K,O)=>{const W=O/(s.length-1)*n,G=e-(K-a)/l*e;return O===0?`M${W},${G}`:`L${W},${G}`}).join(" ")});function b(){if(!r.value)return;const s=r.value.current_equity;typeof s=="number"&&isFinite(s)&&(_.value.push(s),_.value.length>E&&_.value.shift())}function w(s){!s||typeof s!="object"||(s.session&&(r.value={...r.value||{},...s.session}),Array.isArray(s.positions)&&(c.value=s.positions),q.value=Date.now(),typeof s.server_time=="number"&&(h.value=s.server_time*1e3),b())}async function C(){S.value=!0,g.value=null;try{const n=(await Y.get("/api/risk/state")).data;n!=null&&n.session&&(r.value=n.session),c.value=Array.isArray(n==null?void 0:n.positions)?n.positions:[],q.value=Date.now(),b()}catch(s){g.value=s.__friendlyMessage||s.message||"fetch failed"}finally{S.value=!1}}function B(){try{v&&v.close()}catch{}v=null;const n=`${(H==null?void 0:H.VITE_BACKEND_URL)||""}/stream/risk`.replace(/\/$/,"/stream/risk");f.value="offline",v=at({url:n,heartbeatTimeoutMs:15e3},{onOpen:()=>{f.value="online"},onMessage:({type:e,data:a})=>{if(!a)return;if(a.type==="heartbeat"||e==="heartbeat"){typeof a.server_time=="number"&&(h.value=a.server_time*1e3);const l=Date.now()-(h.value||Date.now());f.value=l>15e3?"lagging":"online";return}w(a);const $=Date.now()-(h.value||Date.now());f.value=$>15e3?"lagging":"online"},onError:()=>{f.value="lagging"},onClose:()=>{f.value="offline"}})}function j(){z(),x.value&&(k=setInterval(C,Math.max(3,m.value)*1e3))}function z(){k&&clearInterval(k),k=null}function R(){B()}function N(){if(v){try{v.close()}catch{}v=null}f.value="offline"}function T(s){x.value=typeof s=="boolean"?s:!x.value,x.value&&C(),j()}function U(s){m.value=Math.max(3,s),j()}async function D(s){try{await Y.delete(`/api/trading/positions/${encodeURIComponent(s)}`);const n=c.value.findIndex(e=>e.symbol===s);n>=0&&c.value.splice(n,1),await C()}catch(n){throw g.value=n.__friendlyMessage||n.message||"delete failed",n}}return{session:r,positions:c,loading:S,error:g,lastUpdated:q,auto:x,intervalSec:m,drawdown:L,pnl:A,utilization:P,sparkPath:I,equityHistory:_,connStatus:f,lastServerTs:h,fetchState:C,startAuto:j,stopAuto:z,toggleAuto:T,setIntervalSec:U,deletePosition:D,startLive:R,stopLive:N}}),dt={class:"space-y-6"},ct={class:"card space-y-4"},ft={class:"flex items-center justify-between"},vt={class:"flex items-center gap-3 text-xs"},pt=["disabled"],xt={class:"flex items-center gap-1 cursor-pointer select-none"},mt={class:"flex items-center gap-1"},bt={key:0,class:"px-2 py-0.5 rounded bg-brand-danger/20 text-brand-danger"},yt={class:"grid md:grid-cols-5 gap-4 text-sm"},gt={class:"p-3 rounded bg-neutral-700/40 flex flex-col justify-between"},ht={class:"font-mono font-semibold"},_t={class:"p-3 rounded bg-neutral-700/40 flex flex-col justify-between"},wt={class:"font-mono font-semibold"},kt={class:"p-3 rounded bg-neutral-700/40 flex flex-col justify-between"},Mt={class:"text-neutral-400 flex justify-between items-center"},St={class:"mt-1 h-2 w-full bg-neutral-800 rounded overflow-hidden"},Ct={class:"p-3 rounded bg-neutral-700/40 flex flex-col justify-between"},Dt={class:"p-3 rounded bg-neutral-700/40 flex flex-col justify-between"},qt={class:"text-neutral-400 flex justify-between items-center"},At={class:"mt-1 h-2 w-full bg-neutral-800 rounded overflow-hidden"},jt={class:"flex items-end gap-6"},zt={class:"flex-1"},$t={class:"bg-neutral-800/50 border border-neutral-700 rounded p-2"},Et=["d"],Rt={key:1,class:"h-[30px] text-[10px] text-neutral-600 flex items-center"},Ft={class:"text-[10px] text-neutral-500 min-w-[120px]"},Lt={key:0},Pt={class:"card space-y-3"},It={class:"text-sm font-semibold"},Bt={class:"overflow-x-auto"},Nt={class:"min-w-full text-xs"},Tt={class:"py-1 pr-3 font-mono"},Ut={class:"py-1 pr-3 font-mono text-right"},Vt={class:"py-1 pr-3 font-mono text-right"},Ht={class:"py-1 pr-3 font-mono text-right"},Kt=["disabled","onClick"],Ot={key:0},Wt=100,Gt=30,Jt=tt({__name:"RiskMetrics",setup(r){const c=ut(),{session:S,positions:g,loading:q,error:f,lastUpdated:h,auto:x,intervalSec:m,drawdown:k,pnl:v,utilization:_,sparkPath:E,equityHistory:L}=et(c),{fetchState:A,toggleAuto:P,setIntervalSec:I}=c;nt(()=>{A(),c.startAuto()});const b=y(()=>typeof k.value=="number"?k.value:null),w=y(()=>typeof _.value=="number"?_.value:null),C=y(()=>b.value==null?"0%":Math.min(1,b.value)*100+"%"),B=y(()=>w.value==null?"0%":Math.min(1,w.value)*100+"%"),j=y(()=>v.value==null?"—":v.value.toFixed(2));function z(n){return typeof n=="number"?n.toFixed(2):"—"}function R(n){return typeof n=="number"?n.toFixed(2):"—"}function N(n){return n>.15?"text-brand-danger":n>.07?"text-amber-400":"text-brand-accent"}function T(n){return n==null?"text-neutral-500":n>0?"text-brand-accent":n<0?"text-brand-danger":"text-neutral-500"}function U(n){return n>.8?"text-brand-danger":n>.6?"text-amber-400":"text-brand-accent"}const D=p(null);async function s(n){if(n&&confirm(`${n} 포지션을 삭제할까요?`))try{D.value=n,await c.deletePosition(n)}catch{}finally{D.value=null}}return(n,e)=>{var a,$;return d(),u("div",dt,[t("section",ct,[t("div",ft,[e[8]||(e[8]=t("h1",{class:"text-xl font-semibold"},"Risk Metrics",-1)),t("div",vt,[t("button",{class:"btn",disabled:o(q),onClick:e[0]||(e[0]=(...l)=>o(A)&&o(A)(...l))},"Reload",8,pt),t("label",xt,[J(t("input",{type:"checkbox","onUpdate:modelValue":e[1]||(e[1]=l=>Q(x)?x.value=l:null),onChange:e[2]||(e[2]=l=>o(P)())},null,544),[[st,o(x)]]),e[5]||(e[5]=V(" Auto ",-1))]),t("div",mt,[e[6]||(e[6]=V(" 주기 ",-1)),J(t("input",{type:"range",min:"3",max:"60","onUpdate:modelValue":e[3]||(e[3]=l=>Q(m)?m.value=l:null),onChange:e[4]||(e[4]=l=>o(I)(o(m)))},null,544),[[lt,o(m),void 0,{number:!0}]]),e[7]||(e[7]=V()),t("span",null,i(o(m))+"s",1)]),o(f)?(d(),u("span",bt,i(o(f)),1)):M("",!0)])]),e[15]||(e[15]=t("p",{class:"text-xs text-neutral-400"},"세션 자본 상태, 드로우다운, 포지션 노출을 모니터링합니다.",-1)),t("div",yt,[t("div",gt,[e[9]||(e[9]=t("div",{class:"text-neutral-400"},"Current Equity",-1)),t("div",ht,i(z((a=o(S))==null?void 0:a.current_equity)),1)]),t("div",_t,[e[10]||(e[10]=t("div",{class:"text-neutral-400"},"Peak Equity",-1)),t("div",wt,i(z(($=o(S))==null?void 0:$.peak_equity)),1)]),t("div",kt,[t("div",Mt,[e[11]||(e[11]=t("span",null,"Drawdown",-1)),b.value!=null?(d(),u("span",{key:0,class:F([N(b.value),"text-xs"])},i((b.value*100).toFixed(1))+"%",3)):M("",!0)]),t("div",St,[b.value!=null?(d(),u("div",{key:0,class:"h-full bg-brand-danger transition-all",style:X({width:C.value})},null,4)):M("",!0)])]),t("div",Ct,[e[12]||(e[12]=t("div",{class:"text-neutral-400"},"PnL",-1)),t("div",{class:F(["font-mono font-semibold",T(o(v))])},i(j.value),3)]),t("div",Dt,[t("div",qt,[e[13]||(e[13]=t("span",null,"Utilization",-1)),w.value!=null?(d(),u("span",{key:0,class:F([U(w.value),"text-xs"])},i((w.value*100).toFixed(0))+"%",3)):M("",!0)]),t("div",At,[w.value!=null?(d(),u("div",{key:0,class:"h-full bg-brand-accent transition-all",style:X({width:B.value})},null,4)):M("",!0)])])]),t("div",jt,[t("div",zt,[e[14]||(e[14]=t("h2",{class:"text-xs text-neutral-400 mb-1"},"Equity Sparkline",-1)),t("div",$t,[o(E)?(d(),u("svg",{key:0,width:Wt,height:Gt},[t("path",{d:o(E),fill:"none",stroke:"#10b981","stroke-width":"2"},null,8,Et)])):(d(),u("div",Rt,"No data"))])]),t("div",Ft,[t("div",null,"points: "+i(o(L).length),1),o(h)?(d(),u("div",Lt,"updated: "+i(new Date(o(h)).toLocaleTimeString()),1)):M("",!0)])])]),t("section",Pt,[t("h2",It,"Positions ("+i(o(g).length)+")",1),t("div",Bt,[t("table",Nt,[e[17]||(e[17]=t("thead",{class:"text-neutral-400 border-b border-neutral-700/60"},[t("tr",null,[t("th",{class:"py-1 pr-3 text-left"},"Symbol"),t("th",{class:"py-1 pr-3 text-right"},"Size"),t("th",{class:"py-1 pr-3 text-right"},"Entry"),t("th",{class:"py-1 pr-3 text-right"},"Notional"),t("th",{class:"py-1 pr-3 text-right"},"Actions")])],-1)),t("tbody",null,[(d(!0),u(ot,null,it(o(g),l=>(d(),u("tr",{key:l.symbol,class:"border-b border-neutral-800/40 hover:bg-neutral-800/30"},[t("td",Tt,i(l.symbol),1),t("td",{class:F(["py-1 pr-3 font-mono",l.size===0?"text-neutral-500":l.size>0?"text-brand-accent":"text-brand-danger"])},i(l.size),3),t("td",Ut,i(R(l.entry_price)),1),t("td",Vt,i(R(Math.abs(l.size*l.entry_price))),1),t("td",Ht,[t("button",{class:"btn btn-xs !bg-rose-700 hover:!bg-rose-600",disabled:D.value===l.symbol,onClick:K=>s(l.symbol)},i(D.value===l.symbol?"...":"삭제"),9,Kt)])]))),128)),o(g).length===0?(d(),u("tr",Ot,[...e[16]||(e[16]=[t("td",{colspan:"5",class:"py-3 text-center text-neutral-500"},"No positions",-1)])])):M("",!0)])])])])])}}}),te=rt(Jt,[["__scopeId","data-v-6084cba1"]]);export{te as default};
