import{d as yt,I as xt,k as x,l as R,c as p,m as gt,o as _t,a as u,e as c,z as ht,b as s,p as g,i as P,q as X,E as M,t as r,n as N,f as A,F as I,r as V,B as St,A as K}from"./index-BtrOmqR2.js";import{c as wt}from"./sse-Bs9vxAPf.js";import U from"./http-CilSfrpq.js";import{u as kt}from"./trainingJobs-Csi7WAeR.js";import{C as Ct,c as G}from"./confirmPresets-CzcHK0BG.js";import{_ as Tt}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Mt={class:"space-y-4"},At={class:"grid grid-cols-1 lg:grid-cols-3 gap-4"},Ut={class:"card p-4 space-y-2"},$t={class:"flex items-center justify-between"},Dt={class:"flex items-center gap-2 text-[11px]"},Bt={class:"flex items-center gap-1 cursor-pointer select-none"},Et=["disabled"],Lt=["disabled"],qt={class:"text-xs text-neutral-400"},Rt={class:"mr-2"},Pt={class:"mr-2"},Nt={class:"mr-2"},It={class:"overflow-auto max-h-48"},Vt={class:"w-full text-[11px]"},jt={class:"py-1 px-1 font-mono"},Ft={class:"py-1 px-1"},Ot=["title"],Ht={class:"py-1 px-1 text-right"},Jt={class:"flex items-center gap-2"},Yt={class:"w-20 h-2 bg-neutral-800 rounded overflow-hidden border border-neutral-700"},zt={class:"min-w-[28px] text-right"},Xt={key:0},Kt={key:1,class:"text-neutral-600"},Gt={class:"py-1 px-1"},Qt=["title"],Wt={class:"py-1 px-1"},Zt=["onClick"],te={key:0},ee={class:"card p-4 space-y-2"},se={class:"flex items-center justify-between"},ae={class:"flex items-center gap-2 text-[11px]"},ne={class:"flex items-center gap-1 cursor-pointer select-none"},oe=["disabled"],le={class:"text-xs text-neutral-400"},re={class:"mr-2"},ie={class:"mr-2 text-brand-accent"},ue={class:"text-brand-danger"},ce={class:"overflow-auto max-h-48"},de={class:"w-full text-[11px]"},me={class:"py-1 px-1 font-mono"},ve={class:"py-1 px-1"},pe={class:"py-1 px-1"},fe={key:0},be={class:"card p-4 space-y-3"},ye={class:"text-xs text-neutral-300 space-y-1"},xe={class:"text-neutral-500 text-[11px]"},ge={class:"card p-4"},_e={class:"text-[11px] font-mono space-y-1 max-h-48 overflow-auto"},he={key:0,class:"text-neutral-500"},Q="jobcenter.backfill",Se=yt({__name:"JobCenter",setup(we){const w=xt();function W(){w.push({path:"/admin",query:{tab:"actions"}})}function Z(){w.push({path:"/admin",query:{tab:"training"}})}function tt(){w.push({path:"/admin",query:{tab:"promotion_audit"}})}const a=x({live:!0,items:[],total:0,lastUpdate:null,counts:{running:0,success:0,error:0},_sse:null,symbol:"",interval:"",status:"",limit:50}),$=x({});function et(e){return e==="success"?"bg-emerald-700/30 text-emerald-300 border border-emerald-700/40":e==="running"?"bg-indigo-700/30 text-indigo-300 border border-indigo-700/40":e==="error"?"bg-rose-700/30 text-rose-300 border border-rose-700/40":"bg-neutral-700/30 text-neutral-300 border border-neutral-700/40"}function st(){k()}async function k(){var e,t;try{const o=await U.get("/api/features/backfill/runs",{params:{page:1,page_size:Math.min(Math.max(a.value.limit||50,1),200),sort_by:"started_at",order:"desc",status:a.value.status||void 0,symbol:a.value.symbol||void 0,interval:a.value.interval||void 0}}),l=Array.isArray(o.data)?o.data:Array.isArray((e=o.data)==null?void 0:e.items)?o.data.items:[];a.value.items=l.map(n=>({id:n.id,status:n.status,started_at:n.started_at,requested_target:n.requested_target,inserted:n.inserted,error:n.error,symbol:n.symbol,interval:n.interval})),a.value.total=typeof((t=o.data)==null?void 0:t.total)=="number"?o.data.total:a.value.items.length,a.value.counts=O(a.value.items.map(n=>n.status)),a.value.lastUpdate=Date.now(),b(`[runs] fetched ${a.value.items.length}`),Y(a.value.items)}catch{}}function D(){B();const e=new URLSearchParams;a.value.symbol&&e.set("symbol",a.value.symbol),a.value.interval&&e.set("interval",a.value.interval),a.value.status&&e.set("status",a.value.status),e.set("limit",String(Math.min(Math.max(a.value.limit||50,1),200))),a.value._sse=wt({url:"/stream/runs"+(e.toString()?"?"+e.toString():""),heartbeatTimeoutMs:2e4},{onMessage:t=>{const o=t==null?void 0:t.data;if(o&&Array.isArray(o.items)){const l=o.items;a.value.items=l.map(n=>({id:n.id,status:n.status,started_at:n.started_at,requested_target:n.requested_target,inserted:n.inserted,error:n.error,symbol:n.symbol,interval:n.interval})),a.value.total=Math.max(a.value.total,a.value.items.length),a.value.counts=O(l.map(n=>n.status)),a.value.lastUpdate=Date.now(),b(`[runs] ${l.length} snapshot`),Y(a.value.items)}}})}function B(){try{a.value._sse&&a.value._sse.close()}catch{}a.value._sse=null}R(()=>a.value.live,e=>{e?D():B()}),R(()=>[a.value.symbol,a.value.interval,a.value.status,a.value.limit],()=>{a.value.live&&D()},{deep:!0}),R(a,e=>{try{const t={live:e.live,symbol:e.symbol,interval:e.interval,status:e.status,limit:e.limit};localStorage.setItem(Q,JSON.stringify(t))}catch{}},{deep:!0});const j=Number((window==null?void 0:window.VITE_RUNS_FRESH_MS)??1e4),F=Number((window==null?void 0:window.VITE_RUNS_STALE_MS)??3e4),at=p(()=>{if(!a.value.lastUpdate)return"업데이트 대기중";const e=Date.now()-a.value.lastUpdate,t=Math.floor(e/1e3);return e<=j?`실시간 · ${t}s 전 업데이트`:e<=F?`보통 · ${t}s 전 업데이트`:`느림 · ${t}s 전 업데이트`}),nt=p(()=>{if(!a.value.lastUpdate)return"text-neutral-500";const e=Date.now()-a.value.lastUpdate;return e<=j?"text-emerald-400":e<=F?"text-amber-400":"text-rose-400"});function O(e){const t={running:0,success:0,error:0};for(const o of e)t[o]!==void 0&&t[o]++;return t}const m=kt(),ot=p(()=>m.loading),H=p(()=>m.jobs),lt=p(()=>m.jobs.length),rt=p(()=>m.jobs.filter(e=>e.status==="success").length),it=p(()=>m.jobs.filter(e=>e.status==="error").length),J=p({get:()=>m.auto,set:e=>m.toggleAuto(e)}),E=m.fetchJobs,f=x(null),ut=p(()=>f.value?f.value.in_cooldown?`쿨다운 진행중. 다음 허용: ${f.value.next_allowed_ts?new Date(f.value.next_allowed_ts*1e3).toLocaleString():"N/A"}`:"대기 상태":"");async function L(){try{const e=await fetch("/api/models/promotion/alert/status");e.ok&&(f.value=await e.json())}catch{}}async function ct(){try{const e=G.labelerRun(120,1e3);z({...e,onConfirm:async()=>{const t=new URLSearchParams({force:"true",min_age_seconds:"120",limit:"1000"});await U.post("/api/inference/labeler/run?"+t.toString()),b("[labeler] run requested")}})}catch{}}const _=x([]);function b(e){const t=new Date().toLocaleTimeString();_.value.unshift(`${t} ${e}`),_.value.length>50&&_.value.pop()}function dt(e){if(!e)return"-";try{const t=typeof e=="number"?new Date(e):/^\d/.test(String(e))&&!String(e).includes("T")?new Date(parseFloat(String(e))*1e3):new Date(e),o=S=>S<10?"0"+S:""+S,l=t.getFullYear(),n=o(t.getMonth()+1),d=o(t.getDate()),v=o(t.getHours()),y=o(t.getMinutes()),q=o(t.getSeconds());return`${l}-${n}-${d} ${v}:${y}:${q}`}catch{return String(e)}}function h(e){const t=e.inserted,o=e.requested_target;return typeof t=="number"&&typeof o=="number"&&o>0?Math.max(0,Math.min(100,Math.floor(t/o*100))):null}function Y(e){const t=Date.now(),o=$.value;for(const l of e)typeof l.inserted=="number"&&(o[l.id]={inserted:l.inserted,ts:t});$.value={...o}}function mt(e){const t=h(e);if(t===null||t>=100)return"—";const o=e.requested_target,l=e.inserted;if(!(typeof o=="number"&&typeof l=="number"&&o>l))return"—";const n=$.value[e.id];if(!n)return"—";const d=(Date.now()-n.ts)/1e3,v=l-n.inserted;if(d<=0||v<=0)return"—";const y=v/d;if(y<=0)return"—";const q=o-l,S=Math.max(1,Math.floor(q/y));return vt(S)}function vt(e){if(e<60)return`${e}s`;const t=Math.floor(e/60),o=e%60;if(t<60)return`${t}m ${o}s`;const l=Math.floor(t/60),n=t%60;return`${l}h ${n}m`}function pt(e){const t={tab:"actions"};e.symbol&&(t.bf_symbol=e.symbol),e.interval&&(t.bf_interval=e.interval),e.status&&(t.bf_status=e.status),t.bf_live="1",w.push({path:"/admin",query:t})}const C=x(!1),T=x(!1);async function ft(){if(!C.value){C.value=!0;try{const e=new URLSearchParams;a.value.symbol&&e.set("symbol",a.value.symbol),a.value.interval&&e.set("interval",a.value.interval);const t=await U.post("/api/ohlcv/backfill/year/start"+(e.toString()?"?"+e.toString():""));t!=null&&t.data&&b(`[year_backfill] start: ${t.data.status}`),await k()}catch(e){b(`[year_backfill] start failed: ${(e==null?void 0:e.message)||"error"}`)}finally{C.value=!1}}}async function bt(){T.value||z({...G.yearBackfillCancel(),onConfirm:async()=>{T.value=!0;try{const e=new URLSearchParams;a.value.symbol&&e.set("symbol",a.value.symbol),a.value.interval&&e.set("interval",a.value.interval);const t=await U.post("/api/ohlcv/backfill/year/cancel"+(e.toString()?"?"+e.toString():""));t!=null&&t.data&&b(`[year_backfill] cancel: ${t.data.status}`),await k()}catch(e){b(`[year_backfill] cancel failed: ${(e==null?void 0:e.message)||"error"}`)}finally{T.value=!1}}})}gt(()=>{try{const t=localStorage.getItem(Q);if(t){const o=JSON.parse(t);typeof o.live=="boolean"&&(a.value.live=o.live),typeof o.symbol=="string"&&(a.value.symbol=o.symbol),typeof o.interval=="string"&&(a.value.interval=o.interval),typeof o.status=="string"&&(a.value.status=o.status),typeof o.limit=="number"&&(a.value.limit=Math.min(Math.max(o.limit,1),200))}}catch{}k(),a.value.live&&D(),E(),m.start(),L();const e=setInterval(L,3e4);window.__jobCenter_promoTimer=e}),_t(()=>{B();try{clearInterval(window.__jobCenter_promoTimer)}catch{}});const i=x({open:!1,title:"",message:""});function z(e){i.value.title=e.title,i.value.message=e.message,i.value.requireText=e.requireText,i.value.delayMs=e.delayMs,i.value.onConfirm=async()=>{try{await e.onConfirm()}finally{i.value.open=!1}},i.value.open=!0}return(e,t)=>{var o,l;return c(),u("div",Mt,[ht(Ct,{open:i.value.open,title:i.value.title,message:i.value.message,requireText:i.value.requireText,delayMs:i.value.delayMs,onConfirm:t[0]||(t[0]=n=>i.value.onConfirm&&i.value.onConfirm()),onCancel:t[1]||(t[1]=n=>i.value.open=!1)},null,8,["open","title","message","requireText","delayMs"]),s("div",At,[s("section",Ut,[s("div",$t,[t[15]||(t[15]=s("h2",{class:"text-sm font-semibold"},"Backfill",-1)),s("div",Dt,[s("label",Bt,[g(s("input",{type:"checkbox","onUpdate:modelValue":t[2]||(t[2]=n=>a.value.live=n)},null,512),[[X,a.value.live]]),t[9]||(t[9]=P(" live",-1))]),s("button",{class:"btn btn-xs",onClick:st},"Refresh"),s("button",{class:"btn btn-xs",title:"Admin > Actions로 이동",onClick:W},"Open in Admin"),t[14]||(t[14]=s("div",{class:"h-4 w-px bg-neutral-800 mx-1"},null,-1)),g(s("select",{"onUpdate:modelValue":t[3]||(t[3]=n=>a.value.symbol=n),class:"bg-neutral-900 border border-neutral-700 rounded px-1 py-0.5"},[...t[10]||(t[10]=[s("option",{value:""},"SYMBOL",-1),s("option",{value:"BTCUSDT"},"BTCUSDT",-1),s("option",{value:"ETHUSDT"},"ETHUSDT",-1),s("option",{value:"XRPUSDT"},"XRPUSDT",-1)])],512),[[M,a.value.symbol]]),g(s("select",{"onUpdate:modelValue":t[4]||(t[4]=n=>a.value.interval=n),class:"bg-neutral-900 border border-neutral-700 rounded px-1 py-0.5"},[...t[11]||(t[11]=[s("option",{value:""},"INTERVAL",-1),s("option",{value:"1m"},"1m",-1),s("option",{value:"5m"},"5m",-1),s("option",{value:"1h"},"1h",-1)])],512),[[M,a.value.interval]]),g(s("select",{"onUpdate:modelValue":t[5]||(t[5]=n=>a.value.status=n),class:"bg-neutral-900 border border-neutral-700 rounded px-1 py-0.5"},[...t[12]||(t[12]=[s("option",{value:""},"ALL",-1),s("option",{value:"running"},"running",-1),s("option",{value:"success"},"success",-1),s("option",{value:"error"},"error",-1)])],512),[[M,a.value.status]]),g(s("select",{"onUpdate:modelValue":t[6]||(t[6]=n=>a.value.limit=n),class:"bg-neutral-900 border border-neutral-700 rounded px-1 py-0.5",title:"최대 표시 개수"},[...t[13]||(t[13]=[s("option",{value:10},"10",-1),s("option",{value:25},"25",-1),s("option",{value:50},"50",-1),s("option",{value:100},"100",-1),s("option",{value:200},"200",-1)])],512),[[M,a.value.limit,void 0,{number:!0}]]),s("button",{class:"btn btn-xs",onClick:ft,disabled:C.value},"Year Backfill",8,Et),s("button",{class:"btn btn-xs",onClick:bt,disabled:T.value},"Cancel",8,Lt)])]),s("div",qt,[s("span",Rt,"총 "+r(a.value.total||a.value.items.length),1),s("span",Pt,"running "+r(a.value.counts.running),1),s("span",Nt,"success "+r(a.value.counts.success),1),s("span",null,"error "+r(a.value.counts.error),1),s("span",{class:N(["ml-2 text-[10px]",nt.value])},r(at.value),3)]),s("div",It,[s("table",Vt,[t[17]||(t[17]=s("thead",null,[s("tr",{class:"text-neutral-500 border-b border-neutral-800"},[s("th",{class:"text-left py-1 px-1"},"ID"),s("th",{class:"text-left py-1 px-1"},"Status"),s("th",{class:"text-right py-1 px-1"},"Prog"),s("th",{class:"text-left py-1 px-1"},"ETA"),s("th",{class:"text-left py-1 px-1"},"Started"),s("th",{class:"text-left py-1 px-1"},"Actions")])],-1)),s("tbody",null,[(c(!0),u(I,null,V(a.value.items.slice(0,5),n=>(c(),u("tr",{key:n.id,class:"border-b border-neutral-800/40"},[s("td",jt,r(n.id),1),s("td",Ft,[s("span",{class:N([et(n.status),"px-2 py-0.5 rounded"]),title:n.error||""},r(n.status),11,Ot)]),s("td",Ht,[s("div",Jt,[s("div",Yt,[h(n)!=null?(c(),u("div",{key:0,class:"h-full bg-emerald-600",style:St({width:h(n)+"%"})},null,4)):A("",!0)]),s("span",zt,[h(n)!=null?(c(),u("span",Xt,r(h(n))+"%",1)):(c(),u("span",Kt,"—"))])])]),s("td",Gt,r(mt(n)),1),s("td",{class:"py-1 px-1",title:n.started_at},r(dt(n.started_at)),9,Qt),s("td",Wt,[s("button",{class:"btn btn-xs",title:"Admin Backfill 필터로 보기",onClick:d=>pt(n)},"Open",8,Zt)])]))),128)),a.value.items.length===0?(c(),u("tr",te,[...t[16]||(t[16]=[s("td",{colspan:"3",class:"text-center text-neutral-600 py-2"},"No runs",-1)])])):A("",!0)])])])]),s("section",ee,[s("div",se,[t[19]||(t[19]=s("h2",{class:"text-sm font-semibold"},"Training",-1)),s("div",ae,[s("label",ne,[g(s("input",{type:"checkbox","onUpdate:modelValue":t[7]||(t[7]=n=>J.value=n)},null,512),[[X,J.value]]),t[18]||(t[18]=P(" auto",-1))]),s("button",{class:"btn btn-xs",disabled:ot.value,onClick:t[8]||(t[8]=(...n)=>K(E)&&K(E)(...n))},"Refresh",8,oe),s("button",{class:"btn btn-xs",title:"Admin > Training으로 이동",onClick:Z},"Open in Training")])]),s("div",le,[s("span",re,"전체 "+r(lt.value),1),s("span",ie,"성공 "+r(rt.value),1),s("span",ue,"실패 "+r(it.value),1)]),s("div",ce,[s("table",de,[t[21]||(t[21]=s("thead",null,[s("tr",{class:"text-neutral-500 border-b border-neutral-800"},[s("th",{class:"text-left py-1 px-1"},"ID"),s("th",{class:"text-left py-1 px-1"},"Status"),s("th",{class:"text-left py-1 px-1"},"AUC")])],-1)),s("tbody",null,[(c(!0),u(I,null,V(H.value.slice(0,5),n=>{var d,v,y;return c(),u("tr",{key:n.id,class:"border-b border-neutral-800/40"},[s("td",me,r(n.id),1),s("td",ve,r(n.status),1),s("td",pe,r(((y=(v=(d=n.metrics)==null?void 0:d.auc)==null?void 0:v.toFixed)==null?void 0:y.call(v,3))??"—"),1)])}),128)),H.value.length===0?(c(),u("tr",fe,[...t[20]||(t[20]=[s("td",{colspan:"3",class:"text-center text-neutral-600 py-2"},"No jobs",-1)])])):A("",!0)])])])]),s("section",be,[s("div",{class:"flex items-center justify-between"},[t[22]||(t[22]=s("h2",{class:"text-sm font-semibold"},"Labeler & Promotion",-1)),s("div",{class:"flex items-center gap-2 text-[11px]"},[s("button",{class:"btn btn-xs",onClick:ct},"Run labeler"),s("button",{class:"btn btn-xs",onClick:L},"Promotion status"),s("button",{class:"btn btn-xs",title:"Admin > Promotion으로 이동",onClick:tt},"Open in Promotion")])]),s("div",ye,[s("div",null,[t[23]||(t[23]=P("Promotion: ",-1)),s("span",{class:N((o=f.value)!=null&&o.in_cooldown?"text-amber-400":"text-emerald-400")},r((l=f.value)!=null&&l.in_cooldown?"cooldown":"idle"),3)]),s("div",xe,r(ut.value),1),t[24]||(t[24]=s("div",{class:"text-neutral-500 text-[10px]"},"자세한 작업/확인은 Admin > Actions에서 수행하세요.",-1))])])]),s("section",ge,[t[25]||(t[25]=s("h2",{class:"text-sm font-semibold mb-2"},"Live Events",-1)),s("div",_e,[(c(!0),u(I,null,V(_.value,(n,d)=>(c(),u("div",{key:d,class:"text-neutral-300"},r(n),1))),128)),_.value.length===0?(c(),u("div",he,"No events yet.")):A("",!0)])])])}}}),$e=Tt(Se,[["__scopeId","data-v-dd898adb"]]);export{$e as default};
