import{j as D,k as o,D as J}from"./index-BtrOmqR2.js";import T from"./http-CilSfrpq.js";import{u as V}from"./ohlcv-BSjv8p1h.js";const F=D("inference",()=>{const s=o(.5),d=o("direction"),v=o("production"),i=o(""),I=o(null),u=o([]),h=o(!1),g=o(null),r=o(!1);try{localStorage.getItem("inference_auto")==="true"&&(r.value=!0);const c=localStorage.getItem("inference_threshold");if(c!=null){const l=Number(c);!isNaN(l)&&l>=0&&l<=1&&(s.value=l)}const n=localStorage.getItem("inference_target");(n==="direction"||n==="bottom")&&(d.value=n);const t=localStorage.getItem("inference_select_mode");(t==="production"||t==="latest"||t==="specific")&&(v.value=t);const f=localStorage.getItem("inference_forced_version");typeof f=="string"&&(i.value=f);const a=localStorage.getItem("inference_history_v1");if(a)try{const l=JSON.parse(a);Array.isArray(l)&&(u.value=l.slice(0,30))}catch{}}catch{}const p=o(5);let m=null;const b=30;function N(e,c,n){u.value.unshift({ts:Date.now(),probability:typeof e=="number"&&!isNaN(e)?e:null,decision:typeof c=="number"?c:null,threshold:typeof n=="number"&&!isNaN(n)?n:s.value}),u.value.length>b&&u.value.pop();try{localStorage.setItem("inference_history_v1",JSON.stringify(u.value))}catch{}}async function S(){var e,c,n;try{h.value=!0,g.value=null;const t=V(),f={threshold:s.value,symbol:t.symbol,interval:t.interval,target:d.value};v.value==="latest"?f.use="latest":v.value==="specific"&&i.value&&(f.version=i.value);const a=await T.get("/api/inference/predict",{params:f});if(I.value=a.data,((e=a.data)==null?void 0:e.status)==="ok"){const l=typeof((c=a.data)==null?void 0:c.threshold)=="number"&&!isNaN(a.data.threshold)?a.data.threshold:void 0;N(a.data.probability,a.data.decision,l)}else g.value=((n=a.data)==null?void 0:n.status)||"unknown status"}catch(t){console.warn("[inference] run failed",t),g.value=t.__friendlyMessage||t.message||"request failed"}finally{h.value=!1}}function _(){y(),r.value&&(m=setInterval(()=>{h.value||S()},Math.max(1,p.value)*1e3))}function y(){m&&clearInterval(m),m=null}function x(e){typeof e=="boolean"?r.value=e:r.value=!r.value;try{localStorage.setItem("inference_auto",String(r.value))}catch{}r.value?S():y(),_()}function M(e){s.value=Math.min(1,Math.max(0,e));try{localStorage.setItem("inference_threshold",String(s.value))}catch{}}function A(e){d.value=e;try{localStorage.setItem("inference_target",e)}catch{}}function w(e){v.value=e;try{localStorage.setItem("inference_select_mode",e)}catch{}if(e!=="specific"){i.value="";try{localStorage.removeItem("inference_forced_version")}catch{}}}function O(e){i.value=e;try{localStorage.setItem("inference_forced_version",e)}catch{}}function k(e){p.value=Math.max(1,e),r.value&&_()}J(()=>{y()});function L(e){return e===1?"text-brand-accent":e===-1?"text-brand-danger":"text-neutral-400"}return{threshold:s,selectedTarget:d,selectionMode:v,forcedVersion:i,lastResult:I,history:u,loading:h,error:g,auto:r,intervalSec:p,runOnce:S,toggleAuto:x,setThreshold:M,setTarget:A,setSelectionModeLocal:w,setForcedVersionLocal:O,setIntervalSec:k,startAuto:_,stopAuto:y,decisionColor:L}});export{F as u};
