import{d as pt,k as u,c as k,l as et,m as _t,D as ft,a as l,b as t,f as b,i as _,p as A,v as st,q as vt,E as mt,F as nt,r as at,n as E,t as a,B as yt,u as xt,e as r}from"./index-BtrOmqR2.js";import lt from"./http-CilSfrpq.js";const rt={},bt={class:"space-y-6"},ht={class:"card"},gt={class:"flex items-center justify-between mb-2"},Tt={class:"flex items-center gap-3 text-xs"},Dt={class:"flex items-center gap-1"},wt={class:"flex items-center gap-1"},kt={class:"flex items-center gap-1"},Et={key:0,class:"flex items-center gap-1"},Ft=["disabled"],Nt=["disabled"],It={class:"mt-4 overflow-x-auto"},St={class:"w-full text-sm align-middle"},At={class:"py-1 pr-4 font-medium"},Lt={class:"py-1 pr-4"},Vt={class:"h-2 w-40 bg-neutral-700 rounded overflow-hidden relative"},Mt={class:"py-1 pr-4"},Ut={class:"py-1 pr-4"},Ot={class:"py-1 pr-4"},Rt={class:"py-1 pr-4"},zt={class:"py-1 pr-4"},Bt={class:"py-1 pr-4"},Ct={key:0,class:"text-xs bg-brand-danger/20 text-brand-danger px-1 rounded"},Zt={key:1,class:"text-xs bg-neutral-600/40 text-neutral-300 px-1 rounded"},Ht={key:0},Wt={class:"mt-3 text-xs text-neutral-400 flex flex-wrap gap-4 items-center"},jt={class:"text-neutral-300"},$t={key:0,class:"ml-2 text-[10px] text-amber-400"},Kt={key:0},Xt={key:0},Jt={key:1},Pt={key:2},Yt={class:"card"},qt={class:"flex items-center justify-between mb-2"},Gt={class:"flex items-center gap-2 text-[10px] text-neutral-500"},Qt=["disabled"],te={class:"grid lg:grid-cols-3 gap-4"},ee={class:"space-y-2 lg:col-span-2"},se={key:0,class:"text-xs text-neutral-500"},ne={key:1,class:"space-y-2"},ae=["d"],le={class:"w-full text-[11px]"},re={class:"py-1 pr-2"},oe={class:"py-1 pr-2 text-right"},ie={class:"py-1 pr-2 text-right"},ue=["title"],H="feature_drift_prefs_v2",de="0 0 200 60",fe=pt({__name:"FeatureDrift",setup(ce){const W=rt||{},L=Number(W.VITE_DRIFT_WINDOW_DEFAULT??""),V=Number(W.VITE_DRIFT_Z_THRESHOLD_DEFAULT??""),j=Number.isFinite(L)&&L>=50?L:200,F=Number.isFinite(V)&&V>0?V:3,f=u(j),v=u(F),$=u(["ret_1","ret_5","ret_10","rsi_14","rolling_vol_20","ma_20","ma_50"]),m=u([]),D=u(!1),w=u(F),M=u(null),c=u(null),K=rt||{},U=String(K.VITE_DRIFT_AUTO_DEFAULT??"1").toLowerCase(),X=U==="1"||U==="true"||U==="yes",O=Number(K.VITE_DRIFT_AUTO_INTERVAL_SEC??""),J=Number.isFinite(O)&&O>=10?O:60,p=u(X),y=u(J);let N=null;const R=new Set,z=new Map,h=u([]),B=u(!1),P=k(()=>{if(!m.value.length)return null;let n=1/0;for(const e of m.value)typeof e.n_baseline=="number"&&e.n_baseline>0&&(n=Math.min(n,e.n_baseline));return n===1/0?null:n}),Y=k(()=>{if(!m.value.length)return null;let n=1/0;for(const e of m.value)typeof e.n_recent=="number"&&e.n_recent>0&&(n=Math.min(n,e.n_recent));return n===1/0?null:n}),q=k(()=>{const n=v.value;return typeof n=="number"&&n>0?n:null}),ot=k(()=>{const n=q.value;return n!=null&&Math.abs(n-w.value)>1e-9});async function C(){var n;try{B.value=!0;const e=await lt.get("/api/features/drift/history",{params:{limit:50}});((n=e.data)==null?void 0:n.status)==="ok"&&Array.isArray(e.data.items)&&(h.value=e.data.items)}catch{}finally{B.value=!1}}function it(n){return new Date(n*1e3).toLocaleTimeString()}const G=k(()=>{if(!h.value.length)return"";const n=h.value,e=Math.max(...n.map(x=>x.drift_count),1),s=200,o=60;return n.map((x,g)=>{const T=g/(n.length-1)*s,i=o-x.drift_count/e*o;return g===0?`M${T},${i}`:`L${T},${i}`}).join(" ")});function I(n){return n==null||Number.isNaN(n)?"-":typeof n=="number"?n.toFixed(3):String(n)}async function S(){var n,e;try{D.value=!0,m.value=[];const o=(await lt.get("/api/features/drift/scan",{params:{window:f.value,features:$.value.join(","),threshold:v.value||void 0}})).data;if(o.status==="ok"){const x=$.value[0]??Object.keys(o.results||{})[0],g=x?(e=(n=o.results)==null?void 0:n[x])==null?void 0:e.threshold:void 0;w.value=typeof g=="number"&&g>0?g:F,c.value=o.summary||null;const T=[];for(const i of Object.keys(o.results||{})){const d=o.results[i];if(d.status!=="ok")continue;T.push({feature:i,z_score:d.z_score,baseline_mean:d.baseline_mean,recent_mean:d.recent_mean,n_baseline:d.n_baseline,n_recent:d.n_recent,drift:!!d.drift,status:d.status});const ct=R.has(i),tt=!!d.drift;!ct&&tt&&z.set(i,Date.now()),tt?R.add(i):(R.delete(i),z.delete(i))}T.sort((i,d)=>Math.abs(d.z_score)-Math.abs(i.z_score)),m.value=T,M.value=Date.now(),C()}}catch(s){const o=xt(),x=(s==null?void 0:s.__friendlyMessage)||"드리프트 스캔 실패";o.error(x,"/api/features/drift/scan")}finally{D.value=!1}}S();function ut(n,e){if(!e)return"";const s=z.get(n);if(!s)return"";const o=Date.now()-s;return o<5e3?o%1e3<500?"bg-brand-danger/10":"bg-brand-danger/20":""}function Z(){Q(),p.value&&(N=setInterval(()=>{S()},Math.max(10,y.value)*1e3))}function Q(){N&&clearInterval(N),N=null}et([p,y],()=>{Z()}),et([f,v,p,y],()=>{try{localStorage.setItem(H,JSON.stringify({window:f.value,threshold:v.value,auto:p.value,intervalSec:y.value}))}catch{}}),_t(()=>{try{const n=localStorage.getItem(H);if(n){const e=JSON.parse(n);typeof e.window=="number"&&e.window>=50&&(f.value=e.window),typeof e.threshold=="number"&&e.threshold>0&&(v.value=e.threshold),typeof e.auto=="boolean"&&(p.value=e.auto),typeof e.intervalSec=="number"&&e.intervalSec>=10&&(y.value=e.intervalSec)}}catch{}Z(),C()}),ft(()=>{Q()});function dt(){try{localStorage.removeItem(H)}catch{}f.value=j,v.value=F,p.value=X,y.value=J,Z(),S()}return(n,e)=>(r(),l("div",bt,[t("section",ht,[t("div",gt,[e[9]||(e[9]=t("h1",{class:"text-xl font-semibold"},"Feature Drift",-1)),t("div",Tt,[t("label",Dt,[e[4]||(e[4]=_(" Window ",-1)),A(t("input",{class:"w-20 bg-neutral-700/50 rounded px-1 py-0.5",type:"number","onUpdate:modelValue":e[0]||(e[0]=s=>f.value=s),min:"50"},null,512),[[st,f.value,void 0,{number:!0}]])]),t("label",wt,[e[5]||(e[5]=_(" Threshold(|Z|) ",-1)),A(t("input",{class:"w-20 bg-neutral-700/50 rounded px-1 py-0.5",type:"number",step:"0.1","onUpdate:modelValue":e[1]||(e[1]=s=>v.value=s),min:"0.1"},null,512),[[st,v.value,void 0,{number:!0}]])]),t("label",kt,[e[6]||(e[6]=_(" Auto ",-1)),A(t("input",{type:"checkbox","onUpdate:modelValue":e[2]||(e[2]=s=>p.value=s)},null,512),[[vt,p.value]])]),p.value?(r(),l("label",Et,[e[8]||(e[8]=_(" Every ",-1)),A(t("select",{"onUpdate:modelValue":e[3]||(e[3]=s=>y.value=s),class:"bg-neutral-700/50 rounded px-1 py-0.5"},[...e[7]||(e[7]=[t("option",{value:30},"30s",-1),t("option",{value:60},"60s",-1),t("option",{value:120},"120s",-1),t("option",{value:300},"300s",-1)])],512),[[mt,y.value,void 0,{number:!0}]])])):b("",!0),t("button",{class:"btn",onClick:S,disabled:D.value},"스캔",8,Ft),t("button",{class:"px-2 py-0.5 rounded bg-neutral-700 hover:bg-neutral-600",onClick:dt,disabled:D.value},"추천값 재설정",8,Nt)])]),e[17]||(e[17]=t("p",{class:"text-sm text-neutral-300"},"선택된 피쳐들의 최근 구간 vs 기준 구간 Z-score 기반 드리프트 지표",-1)),t("div",It,[t("table",St,[e[12]||(e[12]=t("thead",{class:"text-neutral-400 text-left"},[t("tr",null,[t("th",{class:"py-1 pr-4"},"Feature"),t("th",{class:"py-1 pr-4"},"Z"),t("th",{class:"py-1 pr-4"},"|Z| Bar"),t("th",{class:"py-1 pr-4"},"Baseline μ"),t("th",{class:"py-1 pr-4"},"Recent μ"),t("th",{class:"py-1 pr-4"},"Δμ"),t("th",{class:"py-1 pr-4"},"N(base)"),t("th",{class:"py-1 pr-4"},"N(recent)"),t("th",{class:"py-1 pr-4"},"Status")])],-1)),t("tbody",null,[(r(!0),l(nt,null,at(m.value,s=>(r(),l("tr",{key:s.feature,class:E(["border-t border-neutral-700/50 transition",ut(s.feature,s.drift)])},[t("td",At,a(s.feature),1),t("td",{class:E(["py-1 pr-4",s.drift?"text-brand-danger font-semibold":"text-neutral-200"])},a(I(s.z_score)),3),t("td",Lt,[t("div",Vt,[e[10]||(e[10]=t("div",{class:"absolute inset-y-0 left-1/2 w-px bg-neutral-500/60"},null,-1)),t("div",{class:E(["h-full",s.drift?"bg-brand-danger":"bg-brand-accent"]),style:yt({width:Math.min(100,Math.abs(s.z_score)/w.value*100)+"%",transform:s.z_score<0?"translateX(50%) scaleX(-1)":"translateX(0)"})},null,6)])]),t("td",Mt,a(I(s.baseline_mean)),1),t("td",Ut,a(I(s.recent_mean)),1),t("td",Ot,a(I(s.recent_mean-s.baseline_mean)),1),t("td",Rt,a(s.n_baseline),1),t("td",zt,a(s.n_recent),1),t("td",Bt,[s.drift?(r(),l("span",Ct,"DRIFT")):(r(),l("span",Zt,"OK"))])],2))),128)),!D.value&&m.value.length===0?(r(),l("tr",Ht,[...e[11]||(e[11]=[t("td",{colspan:"9",class:"py-4 text-center text-neutral-400"},"데이터가 부족하거나 결과가 없습니다.",-1)])])):b("",!0)])])]),t("div",Wt,[t("div",null,[e[13]||(e[13]=_(" 임계값(|Z|) ≥ ",-1)),t("span",jt,a(w.value),1),e[14]||(e[14]=_(" ⇒ DRIFT ",-1)),ot.value?(r(),l("span",$t,"(요청 "+a(q.value??"-")+", 적용 "+a(w.value)+")",1)):b("",!0)]),t("div",null,[_(" Window 요청 "+a(f.value)+" ",1),P.value!=null&&Y.value!=null?(r(),l("span",Kt," → 사용 base "+a(P.value)+", recent "+a(Y.value),1)):b("",!0)]),c.value?(r(),l("div",Xt,[e[15]||(e[15]=_("Drift: ",-1)),t("span",{class:E(c.value.drift_count>0?"text-brand-danger":"text-neutral-300")},a(c.value.drift_count),3),e[16]||(e[16]=_("/",-1)),t("span",null,a(c.value.total),1)])):b("",!0),c.value&&c.value.max_abs_z!=null?(r(),l("div",Jt,"max|Z|="+a(c.value.max_abs_z.toFixed(2))+" ("+a(c.value.top_feature)+")",1)):b("",!0),M.value?(r(),l("div",Pt,"마지막 스캔: "+a(new Date(M.value).toLocaleTimeString()),1)):b("",!0)])]),t("section",Yt,[t("div",qt,[e[18]||(e[18]=t("h2",{class:"text-lg font-semibold"},"Drift History",-1)),t("div",Gt,[t("span",null,"최근 "+a(h.value.length)+"개 스캔",1),t("button",{class:"px-2 py-0.5 rounded bg-neutral-700 hover:bg-neutral-600 text-[10px]",onClick:C,disabled:B.value},"갱신",8,Qt)])]),t("div",te,[t("div",ee,[h.value.length===0?(r(),l("div",se,"히스토리가 없습니다.")):(r(),l("div",ne,[G.value?(r(),l("svg",{key:0,viewBox:de,class:"w-full h-20 bg-neutral-800/40 rounded"},[t("path",{d:G.value,fill:"none",stroke:"#60a5fa","stroke-width":"1.5"},null,8,ae)])):b("",!0),t("table",le,[e[19]||(e[19]=t("thead",{class:"text-neutral-400"},[t("tr",null,[t("th",{class:"py-1 pr-2 text-left"},"Time"),t("th",{class:"py-1 pr-2 text-right"},"Drift"),t("th",{class:"py-1 pr-2 text-right"},"Total"),t("th",{class:"py-1 pr-2 text-right"},"max|Z|"),t("th",{class:"py-1 pr-2 text-left"},"Top Feature")])],-1)),t("tbody",null,[(r(!0),l(nt,null,at(h.value.slice().reverse(),s=>(r(),l("tr",{key:s.ts,class:"border-t border-neutral-700/40"},[t("td",re,a(it(s.ts)),1),t("td",{class:E(["py-1 pr-2 text-right",s.drift_count>0?"text-brand-danger font-medium":"text-neutral-300"])},a(s.drift_count),3),t("td",oe,a(s.total),1),t("td",ie,a(s.max_abs_z!=null?s.max_abs_z.toFixed(2):"-"),1),t("td",{class:"py-1 pr-2 text-left truncate max-w-[140px]",title:s.top_feature||"-"},a(s.top_feature||"-"),9,ue)]))),128))])])]))]),e[20]||(e[20]=t("div",{class:"space-y-2"},[t("div",{class:"text-xs text-neutral-400"},"설명"),t("ul",{class:"text-[11px] list-disc ml-4 space-y-1 text-neutral-300"},[t("li",null,"sparkline: 최근 스캔별 drift_count (좌→우 시간 진행)"),t("li",null,"max|Z|는 각 스캔에서 가장 큰 절대 Z-score"),t("li",null,"Top Feature는 그 시점 최대 변동 피쳐")]),t("div",{class:"text-[10px] text-neutral-500 pt-1"},"* 메모리 상 최대 200개 유지")],-1))])])]))}});export{fe as default};
