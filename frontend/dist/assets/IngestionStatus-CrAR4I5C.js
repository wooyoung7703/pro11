import{d as R,x as D,k,l as E,m as U,G as N,a as d,e as u,b as t,f as x,A as s,p as m,i as S,q as O,C,E as P,t as l,n as j,v as B}from"./index-BtrOmqR2.js";import{u as q}from"./ingestion-LZaYOlHt.js";import _ from"./http-CilSfrpq.js";const G={class:"space-y-4"},J={class:"flex flex-wrap items-center gap-3 text-xs"},H=["disabled"],K={class:"flex items-center gap-1"},Q={class:"flex items-center gap-1"},W={key:0,class:"text-neutral-500"},X={key:1,class:"text-brand-danger"},Y={class:"grid md:grid-cols-3 gap-4"},Z={class:"md:col-span-2 space-y-4"},$={class:"p-3 rounded border border-neutral-700 bg-neutral-900/60"},tt={class:"flex justify-between text-xs text-neutral-400 mb-2"},et={key:0,class:"px-1 rounded bg-brand-danger/20 text-brand-danger"},st={class:"text-[11px] grid grid-cols-2 gap-y-1"},lt={class:"flex justify-between"},nt={class:"flex justify-between"},at={class:"flex justify-between"},ot={class:"flex justify-between"},it={class:"flex justify-between"},dt={class:"flex justify-between"},ut={class:"flex justify-between"},rt={class:"flex justify-between"},ct={class:"flex justify-between"},bt={class:"flex justify-between"},ft={class:"mt-3"},pt={class:"text-[10px] text-neutral-400 mb-1 flex items-center justify-between"},vt={key:0,class:"text-brand-danger"},xt={key:0,width:100,height:24},mt=["d"],_t={key:1,class:"h-6"},gt={class:"space-y-4"},ht={class:"p-3 rounded border border-neutral-700 bg-neutral-900/60"},yt=["disabled"],wt=["disabled"],kt={class:"grid grid-cols-2 gap-2 text-[11px]"},St={class:"flex gap-2 mt-2"},Ct=["disabled"],jt=["disabled"],Bt={class:"flex gap-2 mt-2"},zt=["disabled"],It=["disabled"],Lt={class:"mt-2"},Ft={class:"text-[10px] bg-neutral-900/70 border border-neutral-700 rounded p-2 overflow-auto"},Dt=R({__name:"IngestionStatus",setup(At){const a=q(),{status:n,lag:z,stale:g,sparkPath:h,bufferBarClass:Tt,flushAgeLabel:I,loading:o,error:y,lastUpdated:w,auto:v,intervalSec:p}=D(a),r=k(null),c=k(null);E(n,f=>{f&&(typeof f.batch_size=="number"&&(r.value=f.batch_size),typeof f.flush_interval=="number"&&(c.value=f.flush_interval))},{immediate:!0,deep:!0});function b(){a.fetchStatus()}function L(){a.toggleAuto()}function F(){a.setIntervalSec(p.value??p.value)}async function A(){if(!(!r.value||r.value<1)){try{await _.post("/api/admin/ohlcv/set_batch_size",{size:r.value})}catch{}b()}}async function T(){if(!(!c.value||c.value<=0)){try{await _.post("/api/admin/ohlcv/set_flush_interval",{interval:c.value})}catch{}b()}}async function V(){try{await _.post("/api/admin/ohlcv/force_flush")}catch{}b()}async function M(){try{await _.post("/api/admin/ohlcv/reconnect")}catch{}setTimeout(b,1e3)}return U(()=>{a.fetchStatus(),a.startPolling()}),N(()=>{a.fetchStatus()}),(f,e)=>(u(),d("div",G,[t("div",J,[t("button",{class:"btn",onClick:b,disabled:s(o)},"새로고침",8,H),t("label",K,[m(t("input",{type:"checkbox","onUpdate:modelValue":e[0]||(e[0]=i=>C(v)?v.value=i:null)},null,512),[[O,s(v)]]),e[4]||(e[4]=S(" Auto ",-1))]),t("label",Q,[e[6]||(e[6]=S(" Interval ",-1)),m(t("select",{"onUpdate:modelValue":e[1]||(e[1]=i=>C(p)?p.value=i:null),onChange:F,class:"bg-neutral-800 rounded px-1 py-0.5"},[...e[5]||(e[5]=[t("option",{value:3},"3s",-1),t("option",{value:5},"5s",-1),t("option",{value:10},"10s",-1),t("option",{value:15},"15s",-1)])],544),[[P,s(p),void 0,{number:!0}]])]),s(w)?(u(),d("span",W,"업데이트 "+l(new Date(s(w)).toLocaleTimeString()),1)):x("",!0),s(y)?(u(),d("span",X,"에러: "+l(s(y)),1)):x("",!0)]),t("div",Y,[t("div",Z,[t("div",$,[t("div",tt,[e[7]||(e[7]=t("span",null,"Ingestion 상태",-1)),s(g)?(u(),d("span",et,"STALE")):x("",!0)]),t("dl",st,[t("div",lt,[e[8]||(e[8]=t("dt",{class:"text-neutral-500"},"Enabled",-1)),t("dd",{class:j(s(n).enabled?"text-brand-accent":"text-neutral-500")},l(s(n).enabled?"yes":"no"),3)]),t("div",nt,[e[9]||(e[9]=t("dt",{class:"text-neutral-500"},"Running",-1)),t("dd",{class:j(s(n).running?"text-brand-accent":"text-neutral-500")},l(s(n).running?"yes":"no"),3)]),t("div",at,[e[10]||(e[10]=t("dt",{class:"text-neutral-500"},"Total Msg",-1)),t("dd",null,l(s(n).total_messages??"-"),1)]),t("div",ot,[e[11]||(e[11]=t("dt",{class:"text-neutral-500"},"Reconnect",-1)),t("dd",null,l(s(n).reconnect_attempts??"-"),1)]),t("div",it,[e[12]||(e[12]=t("dt",{class:"text-neutral-500"},"Buffer",-1)),t("dd",null,l(s(n).buffer_size??0)+"/"+l(s(n).batch_size??"-"),1)]),t("div",dt,[e[13]||(e[13]=t("dt",{class:"text-neutral-500"},"Lag(s)",-1)),t("dd",null,l(s(z)),1)]),t("div",ut,[e[14]||(e[14]=t("dt",{class:"text-neutral-500"},"Last Msg",-1)),t("dd",null,l(s(n).last_message_ts?new Date(s(n).last_message_ts*1e3).toLocaleTimeString():"-"),1)]),t("div",rt,[e[15]||(e[15]=t("dt",{class:"text-neutral-500"},"Last Flush",-1)),t("dd",null,l(s(I)),1)]),t("div",ct,[e[16]||(e[16]=t("dt",{class:"text-neutral-500"},"Batch Size",-1)),t("dd",null,l(s(n).batch_size??"-"),1)]),t("div",bt,[e[17]||(e[17]=t("dt",{class:"text-neutral-500"},"Flush Interval",-1)),t("dd",null,l(s(n).flush_interval??"-"),1)])]),t("div",ft,[t("div",pt,[e[18]||(e[18]=t("span",null,"Lag Spark",-1)),s(g)?(u(),d("span",vt,"확인 필요")):x("",!0)]),s(h)?(u(),d("svg",xt,[t("path",{d:s(h),fill:"none",stroke:"#10b981","stroke-width":"2"},null,8,mt)])):(u(),d("div",_t))])])]),t("div",gt,[t("div",ht,[e[21]||(e[21]=t("div",{class:"text-xs font-semibold text-neutral-300 mb-2"},"Controls",-1)),t("button",{class:"btn w-full mb-2",onClick:b,disabled:s(o)},"수동 새로고침",8,yt),t("button",{class:"btn w-full mb-2",onClick:L,disabled:s(o)},"Auto "+l(s(v)?"Off":"On"),9,wt),t("div",kt,[t("div",null,[e[19]||(e[19]=t("div",{class:"text-neutral-400 mb-0.5"},"Batch Size",-1)),m(t("input",{class:"input w-full",type:"number",min:"1",max:"500","onUpdate:modelValue":e[2]||(e[2]=i=>r.value=i)},null,512),[[B,r.value,void 0,{number:!0}]])]),t("div",null,[e[20]||(e[20]=t("div",{class:"text-neutral-400 mb-0.5"},"Flush Interval(s)",-1)),m(t("input",{class:"input w-full",type:"number",step:"0.1",min:"0.05","onUpdate:modelValue":e[3]||(e[3]=i=>c.value=i)},null,512),[[B,c.value,void 0,{number:!0}]])])]),t("div",St,[t("button",{class:"btn flex-1",onClick:A,disabled:s(o)},"적용(Batch)",8,Ct),t("button",{class:"btn flex-1",onClick:T,disabled:s(o)},"적용(Flush)",8,jt)]),t("div",Bt,[t("button",{class:"btn !bg-amber-700 hover:!bg-amber-600 flex-1",onClick:V,disabled:s(o)},"Force Flush",8,zt),t("button",{class:"btn !bg-indigo-700 hover:!bg-indigo-600 flex-1",onClick:M,disabled:s(o)},"Reconnect",8,It)])]),e[22]||(e[22]=t("div",{class:"p-3 rounded border border-neutral-700 bg-neutral-900/60"},[t("div",{class:"text-xs font-semibold text-neutral-300 mb-2"},"설명"),t("ul",{class:"text-[11px] text-neutral-400 space-y-1 list-disc ml-4"},[t("li",null,"Lag(s) = 현재시간 - 마지막 수신 메시지 시간"),t("li",null,"STALE: Lag > 60s"),t("li",null,"Buffer = 배치 DB flush 대기 메시지 수"),t("li",null,"Batch/Flush는 런타임에 조정됩니다. Flush interval 변경은 다음 사이클부터 반영됩니다.")])],-1))])]),t("details",Lt,[e[23]||(e[23]=t("summary",{class:"cursor-pointer text-xs text-neutral-400"},"Raw status debug",-1)),t("pre",Ft,l(JSON.stringify(s(n),null,2)),1)])]))}});export{Dt as default};
