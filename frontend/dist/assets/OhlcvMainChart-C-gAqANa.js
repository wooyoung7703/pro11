import{d as Te,k as R,c,o as $e,a as i,e as u,f as _,b as l,F as O,r as V,t as v,B as Ae,N as Oe}from"./index-BtrOmqR2.js";import{s as Ve,c as Ee,e as Pe,a as Ne}from"./ema-CMLzdVLO.js";import{u as De}from"./ohlcv-BSjv8p1h.js";import{_ as Ke}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./http-CilSfrpq.js";const Le=["width","height"],Xe=["width","height"],ze={transform:"translate(0,0)"},je={class:"price-grid"},We=["x2","y1","y2"],Ye=["y"],Ge={class:"gap-layer"},He=["x","width","height","fill","stroke"],Ue=["x","fill"],qe=["x1","x2","y1","y2","stroke","stroke-dasharray"],Je=["x","y","width","height","fill","opacity"],Qe=["points"],Ze=["points"],et={class:"trade-markers"},tt=["cx","cy","fill"],at={key:2},lt=["x1","x2","y2"],nt=["x2","y1","y2"],ot=["transform"],st={x:"35",y:"13","text-anchor":"middle","font-size":"11",fill:"#cbd3dc"},it=["transform"],ut={x:"45",y:"12","text-anchor":"middle","font-size":"10",fill:"#cbd3dc"},rt=["transform"],ct=["width","height"],ht={class:"vol-grid"},vt=["x2","y1","y2"],dt=["y"],ft=["x","y","width","height","fill"],mt=["x","y","width","height"],xt={x:"6",y:"14","font-size":"11",fill:"#9aa4b1"},pt={key:0,class:"drag-overlay"},gt={class:"tt-row"},yt={class:"tt-row"},wt={class:"tt-row"},Mt={class:"tt-row"},_t={class:"tt-row"},kt={class:"tt-row"},bt={key:0,class:"tt-row"},Bt={key:1,class:"tt-row"},St={key:2,class:"tt-row warn"},Ct={key:3,class:"tt-row"},ie="#2ecc71",ue="#e74c3c",Rt="#247e4d",Ft="#7e2b24",G=20,re=50,It=Te({__name:"OhlcvMainChart",props:{width:{default:860},height:{default:420},volumeRatio:{default:.25},initialBars:{default:120},minBars:{default:20},maxBars:{default:500},tradeMarkers:{default:()=>[]}},setup(g){const x=g,X=De(),A=R(null),m=R(x.initialBars),d=R(0),P=R(!1);let H=0,U=0;const k=c(()=>X.candles),p=c(()=>Math.round(x.height*(1-x.volumeRatio))),b=c(()=>x.height-p.value),n=c(()=>{if(!k.value.length)return[];const e=k.value.length,a=Math.max(0,e-1-d.value),t=Math.max(0,a-m.value+1);return k.value.slice(t,a+1)}),B=c(()=>x.width/Math.max(1,m.value)),$=c(()=>Math.max(1,B.value*.7)),z=c(()=>{if(!n.value.length)return{lo:0,hi:1};let e=n.value[0].low,a=n.value[0].high;for(const t of n.value)t.low<e&&(e=t.low),t.high>a&&(a=t.high);return a===e&&(a+=1,e-=1),{lo:e,hi:a}}),q=c(()=>{let e=0;for(const a of n.value)(a.volume||0)>e&&(e=a.volume||0);return e<=0&&(e=1),{maxV:e}});function F(e){return n.value.indexOf(e)*B.value+(B.value-$.value)/2}function y(e){const{lo:a,hi:t}=z.value,o=t-a;return(t-e)/o*(p.value-2)+1}function N(e){const{maxV:a}=q.value;return p.value+(1-e/a)*(b.value-2)+1-p.value}const ce=c(()=>x.tradeMarkers||[]),J=c(()=>{var o;const e=[];if(!n.value.length||!((o=x.tradeMarkers)!=null&&o.length))return e;const a=n.value[0].open_time,t=n.value[n.value.length-1].open_time;for(const s of ce.value){if(s.time<a||s.time>t)continue;let h=n.value.findIndex(r=>r.open_time===s.time);if(h<0){let r=n.value.findIndex(T=>T.open_time>s.time);h=r<=0?0:r-1}const w=n.value[h],M=F(w)+$.value/2,C=y(s.price);e.push({x:M,y:C,side:s.side,price:s.price})}return e});function he(e){var s;const a=(s=A.value)==null?void 0:s.getBoundingClientRect(),t=a?(e.clientX-a.left)/a.width:.5,o=e.deltaY;if(e.ctrlKey||e.metaKey){const h=m.value,w=Math.round(h*t),M=o>0?1.15:.85;let C=Math.round(h*M);C=Math.min(x.maxBars,Math.max(x.minBars,C)),m.value=C;const r=m.value,T=k.value.length,L=Math.max(0,T-1-d.value),Re=Math.max(0,L-h+1)+w,Fe=Math.max(0,Re-Math.round(r*t))+r-1,Ie=Math.max(0,T-1-Fe);d.value=Math.min(Ie,Math.max(0,T-r))}else{const h=o>0?5:-5;d.value=Math.max(0,Math.min(d.value+h,Math.max(0,k.value.length-m.value)))}}function ve(e){e.button===0&&(P.value=!0,H=e.clientX,U=d.value,window.addEventListener("mousemove",Q),window.addEventListener("mouseup",j))}function Q(e){if(!P.value)return;const a=e.clientX-H,t=Math.round(a/B.value);d.value=Math.max(0,U-t);const o=Math.max(0,k.value.length-m.value);if(d.value>o&&(d.value=o),d.value===o&&t>0){const s=k.value.length?k.value[0].open_time:void 0;s&&X.fetchOlder(s,800).then(h=>{h>0&&(d.value=Math.min(o+h,Math.max(0,k.value.length-m.value)))})}}function j(){P.value=!1,window.removeEventListener("mousemove",Q),window.removeEventListener("mouseup",j)}$e(()=>{j()});const de=c(()=>{if(!n.value.length)return"-";const e=n.value[0].open_time,a=n.value[n.value.length-1].open_time;return`${e} ~ ${a}`}),W=c(()=>{const e=[];let a=Ee(G);for(const t of n.value)Ve(a,t.close),a.buffer.length===G?e.push(a.sum/a.buffer.length):e.push(NaN);return e}),Z=c(()=>{const e=[];let a=Ne(re);for(const t of n.value)e.push(Pe(a,t.close));return e}),ee=c(()=>n.value.map((e,a)=>isNaN(W.value[a])?null:`${F(e)+$.value/2},${y(W.value[a])}`).filter(Boolean).join(" ")),te=c(()=>n.value.map((e,a)=>`${F(e)+$.value/2},${y(Z.value[a])}`).join(" ")),fe=c(()=>X.gapSegments),me=c(()=>{if(!n.value.length)return[];const e=n.value[0].open_time,a=n.value[n.value.length-1].open_time;return fe.value.filter(t=>!(t.to_ts<e||t.from_ts>a))});function ae(e){if(!n.value.length)return 0;const a=n.value[0].open_time,t=n.value[n.value.length-1].open_time,o=Math.max(1,t-a);return(Math.max(a,e.from_ts)-a)/o*x.width}function le(e){if(!n.value.length)return 0;const a=n.value[0].open_time,t=n.value[n.value.length-1].open_time,o=Math.max(1,t-a),s=Math.max(a,e.from_ts),w=(Math.min(t,e.to_ts)-s)/o;return Math.max(2,w*x.width)}const E=R(0),S=R(null),f=c(()=>S.value!=null?n.value[S.value]:null),ne=c(()=>S.value!=null?W.value[S.value]:null),oe=c(()=>S.value!=null?Z.value[S.value]:null);function xe(e){if(!A.value)return;const a=A.value.getBoundingClientRect(),t=e.clientX-a.left,o=Math.floor(t/B.value);o>=0&&o<n.value.length?(S.value=o,E.value=o*B.value+B.value/2):S.value=null;const s=e.clientY-a.top;let h=null;for(const r of J.value){const T=r.x-t,L=r.y-s;if(T*T+L*L<=36){h={side:r.side,price:r.price};break}}D.value=h,K.value=s;const{lo:w,hi:M}=z.value,C=M-w;se.value=M-(s-1)/Math.max(1,p.value-2)*C}function pe(){S.value=null}function I(e){return e>=1||e<=-1?e.toFixed(4):e.toPrecision(4)}function Y(e){return e.is_closed===!1}function ge(e){return e.close>=e.open?ie:ue}function ye(e){return e.close>=e.open?ie:ue}function we(e){const a=e>1e12?e:e*1e3,t=new Date(a),o=String(t.getHours()).padStart(2,"0"),s=String(t.getMinutes()).padStart(2,"0");return`${o}:${s}`}const Me=c(()=>{if(!f.value||!A.value)return{};const e=A.value.getBoundingClientRect();return{left:Math.min(e.width-140,Math.max(0,E.value+12))+"px",top:"8px"}}),D=R(null),K=R(0),se=R(0),_e=c(()=>{const e=[],{lo:a,hi:t}=z.value;if(!isFinite(a)||!isFinite(t)||t<=a)return e;const s=(t-a)/5,h=Math.pow(10,Math.floor(Math.log10(s))),w=[1,2,2.5,5,10].map(r=>r*h);let M=w[w.length-1];for(const r of w)if(s<=r){M=r;break}const C=Math.ceil(a/M)*M;for(let r=C;r<=t&&(e.push({value:r,label:ke(r)}),!(e.length>8));r+=M);return e});function ke(e){return Math.abs(e)>=1e3?e.toFixed(0):Math.abs(e)>=100?e.toFixed(1):Math.abs(e)>=1?e.toFixed(2):e.toPrecision(3)}const be=c(()=>{const e=[],{maxV:a}=q.value;if(!isFinite(a)||a<=0)return e;const t=3;for(let o=1;o<=t;o++){const s=o/t,h=a*s;e.push({value:h,ratio:s,label:Be(h)})}return e.reverse()});function Be(e){return e>=1e9?(e/1e9).toFixed(2)+"B":e>=1e6?(e/1e6).toFixed(2)+"M":e>=1e3?(e/1e3).toFixed(2)+"K":e.toFixed(0)}function Se(e){e.key==="ArrowLeft"?d.value=Math.min(k.value.length,d.value+Math.max(5,Math.round(m.value*.1))):e.key==="ArrowRight"?d.value=Math.max(0,d.value-Math.max(5,Math.round(m.value*.1))):e.key==="+"||e.key==="="&&(e.shiftKey||!e.ctrlKey)?m.value=Math.max(x.minBars,Math.round(m.value*.85)):e.key==="-"&&(m.value=Math.min(x.maxBars,Math.round(m.value*1.15)))}return(e,a)=>(u(),i("div",{class:"ohlcv-main-chart",ref_key:"root",ref:A,tabindex:"0",onKeydown:Se,onWheel:Oe(he,["prevent"]),onMousedown:ve,onMousemove:xe,onMouseleave:pe},[(u(),i("svg",{width:g.width,height:g.height},[l("rect",{width:g.width,height:g.height,fill:"#0d0f14"},null,8,Xe),l("g",ze,[l("g",je,[(u(!0),i(O,null,V(_e.value,t=>(u(),i("g",{key:"pt"+t.value},[l("line",{x1:0,x2:g.width,y1:y(t.value),y2:y(t.value),stroke:"#1d232c","stroke-width":"1","stroke-dasharray":"2,4"},null,8,We),l("text",{x:4,y:y(t.value)-2,"font-size":"10",fill:"#596471"},v(t.label),9,Ye)]))),128))]),l("g",Ge,[(u(!0),i(O,null,V(me.value,t=>(u(),i("g",{key:t.from_ts+"-"+t.to_ts},[l("rect",{x:ae(t),y:"1",width:le(t),height:p.value-2,fill:t.state==="open"?"rgba(255,120,0,0.08)":"rgba(80,160,255,0.05)",stroke:t.state==="open"?"#ff7800aa":"#4ea1ffaa","stroke-width":"1","stroke-dasharray":"4,4"},null,8,He),le(t)>34?(u(),i("text",{key:0,x:ae(t)+4,y:12,"font-size":"10",fill:t.state==="open"?"#ffb273":"#8ec4ff"},v(t.missing)+"ms "+v(t.state==="open"?"OPEN":"OK"),9,Ue)):_("",!0)]))),128))]),(u(!0),i(O,null,V(n.value,t=>(u(),i("g",{key:t.open_time},[l("line",{class:"wick",x1:F(t)+B.value/2,x2:F(t)+B.value/2,y1:y(t.high),y2:y(t.low),stroke:ye(t),"stroke-dasharray":Y(t)?"2,2":"none","stroke-width":"1"},null,8,qe),l("rect",{class:"body",x:F(t),y:y(Math.max(t.open,t.close)),width:$.value,height:Math.max(1,Math.abs(y(t.open)-y(t.close))),fill:ge(t),opacity:Y(t)?.45:1},null,8,Je)]))),128)),ee.value.length?(u(),i("polyline",{key:0,points:ee.value,fill:"none",stroke:"#ffaa00","stroke-width":"1.2","stroke-linejoin":"round","stroke-linecap":"round"},null,8,Qe)):_("",!0),te.value.length?(u(),i("polyline",{key:1,points:te.value,fill:"none",stroke:"#4ea1ff","stroke-width":"1.2","stroke-linejoin":"round","stroke-linecap":"round",opacity:"0.85"},null,8,Ze)):_("",!0),l("g",et,[(u(!0),i(O,null,V(J.value,(t,o)=>(u(),i("g",{key:"m"+o},[l("circle",{cx:t.x,cy:t.y,r:"4",fill:t.side==="buy"?"#34d399":"#f87171",stroke:"#0b0e13","stroke-width":"1"},null,8,tt)]))),128))]),f.value?(u(),i("g",at,[l("line",{x1:E.value,x2:E.value,y1:"0",y2:p.value,stroke:"#888","stroke-dasharray":"3,3","stroke-width":"1"},null,8,lt),l("line",{x1:0,x2:g.width,y1:K.value,y2:K.value,stroke:"#707782","stroke-dasharray":"3,5","stroke-width":"1",opacity:"0.7"},null,8,nt),l("g",{transform:`translate(${g.width-74}, ${Math.max(12,Math.min(p.value-12,K.value))-10})`},[a[0]||(a[0]=l("rect",{width:"70",height:"20",rx:"4",ry:"4",fill:"#0f1319",stroke:"#2a3340"},null,-1)),l("text",st,v(I(se.value)),1)],8,ot),l("g",{transform:`translate(${Math.max(4,Math.min(g.width-90,E.value-45))}, ${p.value+2})`},[a[1]||(a[1]=l("rect",{width:"90",height:"18",rx:"4",ry:"4",fill:"#0f1319",stroke:"#2a3340"},null,-1)),l("text",ut,v(we(f.value.open_time)),1)],8,it)])):_("",!0)]),l("g",{transform:`translate(0,${p.value})`},[l("rect",{width:g.width,height:b.value,fill:"#11151d"},null,8,ct),l("g",ht,[(u(!0),i(O,null,V(be.value,t=>(u(),i("g",{key:"vt"+t.value},[l("line",{x1:0,x2:g.width,y1:p.value+(b.value-t.ratio*b.value),y2:p.value+(b.value-t.ratio*b.value),stroke:"#1a2027","stroke-width":"1","stroke-dasharray":"2,6"},null,8,vt),l("text",{x:4,y:p.value+(b.value-t.ratio*b.value)-2,"font-size":"9",fill:"#49525d"},v(t.label),9,dt)]))),128))]),(u(!0),i(O,null,V(n.value,t=>(u(),i("rect",{key:"v"+t.open_time,class:"vol",x:F(t),y:N(t.volume||0),width:$.value,height:Math.max(1,b.value-N(t.volume||0)),fill:t.close>=t.open?Rt:Ft,opacity:"0.85"},null,8,ft))),128)),f.value?(u(),i("rect",{key:0,x:F(f.value),y:N(f.value.volume||0),width:$.value,height:Math.max(1,b.value-N(f.value.volume||0)),fill:"#ffffff22"},null,8,mt)):_("",!0)],8,rt),l("text",xt,"Bars: "+v(n.value.length)+" | Range: "+v(de.value),1)],8,Le)),P.value?(u(),i("div",pt,"DRAG")):_("",!0),f.value?(u(),i("div",{key:1,class:"tt",style:Ae(Me.value)},[l("div",gt,[a[2]||(a[2]=l("span",null,"T",-1)),l("b",null,v(f.value.open_time),1)]),l("div",yt,[a[3]||(a[3]=l("span",null,"O",-1)),l("b",null,v(I(f.value.open)),1)]),l("div",wt,[a[4]||(a[4]=l("span",null,"H",-1)),l("b",null,v(I(f.value.high)),1)]),l("div",Mt,[a[5]||(a[5]=l("span",null,"L",-1)),l("b",null,v(I(f.value.low)),1)]),l("div",_t,[a[6]||(a[6]=l("span",null,"C",-1)),l("b",null,v(I(f.value.close)),1)]),l("div",kt,[a[7]||(a[7]=l("span",null,"V",-1)),l("b",null,v(f.value.volume??"-"),1)]),ne.value!=null?(u(),i("div",bt,[l("span",null,"SMA"+v(G)),l("b",null,v(I(ne.value)),1)])):_("",!0),oe.value!=null?(u(),i("div",Bt,[l("span",null,"EMA"+v(re)),l("b",null,v(I(oe.value)),1)])):_("",!0),Y(f.value)?(u(),i("div",St,"partial")):_("",!0),D.value?(u(),i("div",Ct,[a[8]||(a[8]=l("span",null,"TRADE",-1)),l("b",null,v(D.value.side.toUpperCase())+" @ "+v(I(D.value.price)),1)])):_("",!0)],4)):_("",!0)],544))}}),Pt=Ke(It,[["__scopeId","data-v-3bcadca5"]]);export{Pt as default};
