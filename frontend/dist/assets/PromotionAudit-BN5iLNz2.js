import{j as ct,k as p,c as G,d as pt,m as mt,a as d,e as c,f as O,b as e,A as n,t as l,n as W,F as et,r as ot,B as nt,p as j,i as x,q as ft,C as H,v as rt,E as at,O as _t,z as S}from"./index-BtrOmqR2.js";import{_ as vt}from"./_plugin-vue_export-helper-DlAUqK2U.js";const xt=ct("promotionAudit",()=>{const L=p([]),V=p(!1),U=p(null),b=p(!0),F=p(15);try{localStorage.getItem("promotion_audit_auto")==="false"&&(b.value=!1);const a=localStorage.getItem("promotion_audit_interval");if(a){const i=parseInt(a,10);isFinite(i)&&i>=5&&i<=120&&(F.value=i)}}catch{}let A=null;const M=p(null),K=p(null),D=p(""),g=p("created_at"),h=p("desc"),I=p(null),E=p(null),f=p([]);function _(s){return s?s.startsWith("auc+")?"criteria_met":s.startsWith("criteria_not_met")?"criteria_not_met":s.startsWith("no_production")?"no_production":s.startsWith("insufficient_val_samples")?"insufficient_val_samples":s.startsWith("promotion_failed")?"promotion_failed":s.startsWith("policy_error")?"policy_error":"other":"unknown"}const y=G(()=>L.value.map(s=>({...s,reason_category:_(s.reason||null),auc_improve:s.auc_improve??q(s.reason),ece_delta:s.ece_delta??J(s.reason),val_samples:s.val_samples??u(s.reason),auc_ratio:s.auc_ratio??(typeof s.auc_improve=="number"&&window.CFG_MIN_AUC_DELTA?s.auc_improve/window.CFG_MIN_AUC_DELTA:null),ece_margin_ratio:s.ece_margin_ratio??(typeof s.ece_delta=="number"&&window.CFG_MAX_ECE_DELTA?(window.CFG_MAX_ECE_DELTA-s.ece_delta)/window.CFG_MAX_ECE_DELTA:null)})));function q(s){if(!s)return null;const a=s.match(/auc\+([0-9.+-]+)/)||s.match(/criteria_not_met_auc([0-9.+-]+)/);if(a){const i=parseFloat(a[1]);return isFinite(i)?i:null}return null}function J(s){if(!s)return null;const a=s.match(/ece_delta(-?[0-9.]+)/);if(a){const i=parseFloat(a[1]);return isFinite(i)?i:null}return null}function u(s){if(!s)return null;const a=s.match(/val(\d+)/)||s.match(/insufficient_val_samples:(\d+)/);if(a){const i=parseInt(a[1]);return isFinite(i)?i:null}return null}const k=G(()=>y.value.filter(s=>{if(M.value&&s.decision!==M.value||K.value&&s.reason_category!==K.value)return!1;if(D.value){const a=D.value.toLowerCase();if(!(s.reason||"").toLowerCase().includes(a)&&!String(s.model_id||"").includes(a))return!1}return!0})),Q=G(()=>{const s=[...k.value];return s.sort((a,i)=>{const w=g.value,v=a[w],m=i[w];return v==null&&m==null?0:v==null?1:m==null?-1:v===m?0:h.value==="asc"?v>m?1:-1:v<m?1:-1}),s});async function X(s=200){V.value=!0,U.value=null;try{const a=await fetch(`/api/models/promotion/events?limit=${s}`,{headers:{"X-API-Key":window.API_KEY||"dev-key"}});if(!a.ok)throw new Error("HTTP "+a.status);const i=await a.json();L.value=i.events||[];const w=[];for(const v of L.value)if(v.decision==="promoted"){const m=v.auc_improve;typeof m=="number"&&isFinite(m)&&w.push(m)}f.value=w.slice(-40)}catch(a){U.value=a.message||String(a)}finally{V.value=!1}}async function P(s=200){E.value=null;try{const a=await fetch(`/api/models/promotion/summary?window=${s}`,{headers:{"X-API-Key":s.API_KEY||"dev-key"}});if(!a.ok)throw new Error("HTTP "+a.status);const i=await a.json();I.value=i.summary||null}catch(a){E.value=a.message||String(a)}}function z(s){g.value===s?h.value=h.value==="asc"?"desc":"asc":(g.value=s,h.value=s==="created_at"?"desc":"asc")}function $(){R(),b.value&&(X(),A=setInterval(()=>X(),F.value*1e3))}function R(){A&&(clearInterval(A),A=null)}function N(s){b.value=s;try{localStorage.setItem("promotion_audit_auto",String(s))}catch{}s?$():R()}function Z(s){F.value=Math.max(5,Math.min(120,Math.floor(s)));try{localStorage.setItem("promotion_audit_interval",String(F.value))}catch{}b.value&&$()}function Y(s){switch(s){case"criteria_met":return"bg-emerald-600/20 text-emerald-400";case"promoted":return"bg-emerald-600/20 text-emerald-400";case"no_production":return"bg-sky-600/20 text-sky-400";case"criteria_not_met":return"bg-amber-600/20 text-amber-400";case"insufficient_val_samples":return"bg-rose-600/20 text-rose-400";case"promotion_failed":return"bg-red-600/20 text-red-400";case"policy_error":return"bg-fuchsia-600/20 text-fuchsia-400";case"other":return"bg-neutral-600/20 text-neutral-300";default:return"bg-neutral-700/30 text-neutral-400"}}return{events:L,loading:V,error:U,auto:b,intervalSec:F,setAuto:N,setIntervalSeconds:Z,fetchEvents:X,start:$,stop:R,filtered:k,sorted:Q,search:D,filterDecision:M,filterReasonCat:K,sortKey:g,sortDir:h,setSort:z,badgeColor:Y,classifyReason:_,summary:I,summaryError:E,fetchSummary:P,aucSpark:f}}),yt={class:"space-y-6"},gt={key:0,class:"card p-4"},ht={class:"text-sm font-semibold mb-3 tracking-wide text-neutral-300"},kt={class:"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 text-xs"},bt={class:"flex flex-col"},wt={class:"text-lg font-mono"},Ct={class:"flex flex-col"},St={class:"text-lg font-mono"},At={class:"flex flex-col"},Dt={class:"text-lg font-mono"},Et={class:"flex flex-col"},Ft={class:"text-lg font-mono"},Mt={class:"flex flex-col"},Kt={class:"text-lg font-mono"},It={class:"flex flex-col"},Pt={class:"mt-4"},Tt=["points"],Lt=["y1","y2"],Vt={key:1,class:"text-[11px] text-neutral-500"},Ut={class:"mt-5 grid md:grid-cols-2 gap-6"},$t={key:0,class:"flex items-end gap-1 h-28"},Rt=["title"],Nt={key:1,class:"text-[11px] text-neutral-600"},Wt={key:0,class:"flex items-end gap-1 h-28"},jt=["title"],Ht={key:1,class:"text-[11px] text-neutral-600"},Bt={class:"card"},Gt={class:"flex items-center justify-between mb-4 flex-wrap gap-3"},Xt={class:"flex items-center gap-3 text-xs flex-wrap"},zt=["disabled"],Yt={class:"flex items-center gap-1 cursor-pointer select-none"},Ot={class:"flex items-center gap-1"},qt={class:"flex items-center gap-1"},Jt={key:0,class:"px-2 py-0.5 rounded bg-brand-danger/20 text-brand-danger"},Qt={class:"overflow-x-auto"},Zt={class:"min-w-full text-sm select-none"},te={class:"text-left text-neutral-400 border-b border-neutral-700/60"},ee={class:"py-1 pr-4 font-mono"},oe=["title"],se={class:"py-1 pr-4"},ne=["title"],re={class:"py-1 pr-4"},ae={class:"py-1 pr-4 font-mono"},le={class:"py-1 pr-4 font-mono"},ie={class:"py-1 pr-4 font-mono"},ue={class:"py-1 pr-4 font-mono"},de=["title"],ce=["title"],pe={class:"py-1 pr-4 font-mono"},me={key:0},st=260,B=54,fe=pt({__name:"PromotionAudit",setup(L){const V=xt(),{fetchEvents:U,start:b,stop:F,sorted:A,loading:M,error:K,auto:D,intervalSec:g,filterDecision:h,filterReasonCat:I,search:E,setSort:f,sortKey:_,sortDir:y,badgeColor:q,fetchSummary:J,summary:u,aucSpark:k,setAuto:Q,setIntervalSeconds:X}=V;function P(r){return typeof r=="number"&&isFinite(r)?r.toFixed(4):"—"}function z(r){return typeof r=="number"&&isFinite(r)?Math.round(r):"—"}function $(r){return typeof r=="number"&&isFinite(r)?(r*100).toFixed(1)+"%":"—"}const R=G(()=>{if(!k.length)return"";const r=[...k],t=Math.min(...r,0),T=Math.max(...r,1e-6)-t||1,tt=st/Math.max(1,r.length-1);return r.map((lt,it)=>{const ut=it*tt,dt=B-(lt-t)/T*B;return`${ut},${dt}`}).join(" ")}),N=G(()=>{if(!k.length)return null;const r=Math.min(...k,0),t=Math.max(...k,0);if(r>0||t<0)return null;const o=t-r||1;return B-(0-r)/o*B});function Z(){U()}function Y(){b()}function s(r){if(!r)return"—";try{return new Date(r).toLocaleTimeString()}catch{return r}}function a(r){switch(r){case"promoted":return"text-emerald-400";case"skipped":return"text-neutral-400";case"error":return"text-red-400";default:return"text-neutral-500"}}function i(r){return typeof r!="number"||!isFinite(r)?"—":r.toFixed(2)+"x"}function w(r,t){return typeof r!="number"||!isFinite(r)?"text-neutral-500":t?r>=1.2?"text-emerald-400":r>=1?"text-emerald-300":r>=.8?"text-amber-300":"text-rose-400":r>=1?"text-emerald-400":r>=.5?"text-emerald-300":r>=0?"text-amber-300":"text-rose-400"}function v(r,t){if(!t||!t.length)return 0;const o=Math.max(...t.map(tt=>tt.count||0),1);return(typeof r=="number"?r:0)/o*100}function m(r){if(typeof r!="string")return"";if(r.startsWith("(")||r.startsWith("[")){const t=r.match(/([-0-9.]+),(inf|[-0-9.]+)/);if(t){const o=t[1],T=t[2];return T==="inf"?o+"+":o==="-inf"?"<"+T:o+"–"+T}}return r}const C=r=>r.sortKey!==r.k?null:r.sortDir==="asc"?"▲":"▼";return mt(()=>{Q(!0),J(),b()}),(r,t)=>(c(),d("div",yt,[n(u)?(c(),d("section",gt,[e("h2",ht,"Summary (window="+l(n(u).window)+")",1),e("div",kt,[e("div",bt,[t[13]||(t[13]=e("span",{class:"text-neutral-500"},"Promotion Rate",-1)),e("span",wt,l($(n(u).promotion_rate)),1)]),e("div",Ct,[t[14]||(t[14]=e("span",{class:"text-neutral-500"},"Promoted / Total",-1)),e("span",St,l(n(u).promoted)+" / "+l(n(u).total),1)]),e("div",At,[t[15]||(t[15]=e("span",{class:"text-neutral-500"},"ΔAUC Avg / Med",-1)),e("span",Dt,l(P(n(u).auc_improve_avg))+" / "+l(P(n(u).auc_improve_median)),1)]),e("div",Et,[t[16]||(t[16]=e("span",{class:"text-neutral-500"},"ΔECE Avg / Med",-1)),e("span",Ft,l(P(n(u).ece_delta_avg))+" / "+l(P(n(u).ece_delta_median)),1)]),e("div",Mt,[t[17]||(t[17]=e("span",{class:"text-neutral-500"},"ValSamples Avg / Med",-1)),e("span",Kt,l(z(n(u).val_samples_avg))+" / "+l(z(n(u).val_samples_median)),1)]),e("div",It,[t[18]||(t[18]=e("span",{class:"text-neutral-500"},"Errors",-1)),e("span",{class:W(["text-lg font-mono",n(u).errors?"text-amber-400":"text-neutral-400"])},l(n(u).errors),3)])]),e("div",Pt,[t[19]||(t[19]=e("h3",{class:"text-[11px] uppercase tracking-wide text-neutral-500 mb-1"},"ΔAUC Sparkline (Promoted)",-1)),n(k).length>1?(c(),d("svg",{key:0,width:st,height:B,class:"overflow-visible"},[e("polyline",{points:R.value,fill:"none",class:"stroke-emerald-400","stroke-width":"1.5"},null,8,Tt),N.value!==null?(c(),d("line",{key:0,x1:0,x2:st,y1:N.value,y2:N.value,class:"stroke-neutral-600","stroke-dasharray":"2,3","stroke-width":"1"},null,8,Lt)):O("",!0)])):(c(),d("div",Vt,"insufficient data"))]),e("div",Ut,[e("div",null,[t[20]||(t[20]=e("h3",{class:"text-[11px] uppercase tracking-wide text-neutral-500 mb-2"},"ΔAUC Histogram",-1)),n(u).auc_improve_hist?(c(),d("div",$t,[(c(!0),d(et,null,ot(n(u).auc_improve_hist,o=>(c(),d("div",{key:o.bucket,class:"flex flex-col items-center justify-end flex-1"},[e("div",{class:"w-full bg-emerald-500/60 rounded-t",style:nt({height:v(o.count,n(u).auc_improve_hist)+"%"})},null,4),e("div",{class:"text-[9px] mt-1 text-center truncate max-w-full",title:o.bucket},l(m(o.bucket)),9,Rt)]))),128))])):(c(),d("div",Nt,"no data"))]),e("div",null,[t[21]||(t[21]=e("h3",{class:"text-[11px] uppercase tracking-wide text-neutral-500 mb-2"},"ECE Δ Histogram",-1)),n(u).ece_delta_hist?(c(),d("div",Wt,[(c(!0),d(et,null,ot(n(u).ece_delta_hist,o=>(c(),d("div",{key:o.bucket,class:"flex flex-col items-center justify-end flex-1"},[e("div",{class:"w-full bg-sky-500/60 rounded-t",style:nt({height:v(o.count,n(u).ece_delta_hist)+"%"})},null,4),e("div",{class:"text-[9px] mt-1 text-center truncate max-w-full",title:o.bucket},l(m(o.bucket)),9,jt)]))),128))])):(c(),d("div",Ht,"no data"))])])])):O("",!0),e("section",Bt,[e("div",Gt,[t[27]||(t[27]=e("h1",{class:"text-xl font-semibold"},"Promotion Audit",-1)),e("div",Xt,[e("button",{class:"btn",disabled:n(M),onClick:Z},"새로고침",8,zt),e("label",Yt,[j(e("input",{type:"checkbox","onUpdate:modelValue":t[0]||(t[0]=o=>H(D)?D.value=o:null),onChange:Y},null,544),[[ft,n(D)]]),t[22]||(t[22]=x(" 자동 ",-1))]),e("div",Ot,[t[23]||(t[23]=x(" 간격 ",-1)),j(e("input",{type:"range",min:"5",max:"60","onUpdate:modelValue":t[1]||(t[1]=o=>H(g)?g.value=o:null),onChange:Y},null,544),[[rt,n(g),void 0,{number:!0}]]),t[24]||(t[24]=x()),e("span",null,l(n(g))+"s",1)]),e("div",qt,[j(e("select",{"onUpdate:modelValue":t[2]||(t[2]=o=>H(h)?h.value=o:null),class:"bg-neutral-800 px-2 py-1 rounded"},[...t[25]||(t[25]=[e("option",{value:null},"decision: ALL",-1),e("option",{value:"promoted"},"promoted",-1),e("option",{value:"skipped"},"skipped",-1),e("option",{value:"error"},"error",-1)])],512),[[at,n(h)]]),j(e("select",{"onUpdate:modelValue":t[3]||(t[3]=o=>H(I)?I.value=o:null),class:"bg-neutral-800 px-2 py-1 rounded"},[...t[26]||(t[26]=[e("option",{value:null},"reason: ALL",-1),_t('<option value="criteria_met" data-v-7082da83>criteria_met</option><option value="no_production" data-v-7082da83>no_production</option><option value="criteria_not_met" data-v-7082da83>criteria_not_met</option><option value="insufficient_val_samples" data-v-7082da83>insufficient_val_samples</option><option value="promotion_failed" data-v-7082da83>promotion_failed</option><option value="policy_error" data-v-7082da83>policy_error</option><option value="other" data-v-7082da83>other</option><option value="unknown" data-v-7082da83>unknown</option>',8)])],512),[[at,n(I)]]),j(e("input",{"onUpdate:modelValue":t[4]||(t[4]=o=>H(E)?E.value=o:null),placeholder:"search reason/model",class:"bg-neutral-800 px-2 py-1 rounded w-40"},null,512),[[rt,n(E)]])]),n(K)?(c(),d("span",Jt,l(n(K)),1)):O("",!0)])]),e("div",Qt,[e("table",Zt,[e("thead",te,[e("tr",null,[e("th",{class:"py-1 pr-4 cursor-pointer",onClick:t[5]||(t[5]=o=>n(f)("id"))},[t[28]||(t[28]=x("ID ",-1)),S(C,{k:"id",sortKey:n(_),sortDir:n(y)},null,8,["sortKey","sortDir"])]),e("th",{class:"py-1 pr-4 cursor-pointer",onClick:t[6]||(t[6]=o=>n(f)("created_at"))},[t[29]||(t[29]=x("Created ",-1)),S(C,{k:"created_at",sortKey:n(_),sortDir:n(y)},null,8,["sortKey","sortDir"])]),e("th",{class:"py-1 pr-4 cursor-pointer",onClick:t[7]||(t[7]=o=>n(f)("decision"))},[t[30]||(t[30]=x("Decision ",-1)),S(C,{k:"decision",sortKey:n(_),sortDir:n(y)},null,8,["sortKey","sortDir"])]),t[36]||(t[36]=e("th",{class:"py-1 pr-4"},"Reason",-1)),t[37]||(t[37]=e("th",{class:"py-1 pr-4"},"Reason Cat",-1)),t[38]||(t[38]=e("th",{class:"py-1 pr-4"},"Model",-1)),t[39]||(t[39]=e("th",{class:"py-1 pr-4"},"Prev Prod",-1)),t[40]||(t[40]=e("th",{class:"py-1 pr-4"},"Samples Old",-1)),t[41]||(t[41]=e("th",{class:"py-1 pr-4"},"Samples New",-1)),e("th",{class:"py-1 pr-4 cursor-pointer",onClick:t[8]||(t[8]=o=>n(f)("auc_improve"))},[t[31]||(t[31]=x("ΔAUC ",-1)),S(C,{k:"auc_improve",sortKey:n(_),sortDir:n(y)},null,8,["sortKey","sortDir"])]),e("th",{class:"py-1 pr-4 cursor-pointer",onClick:t[9]||(t[9]=o=>n(f)("ece_delta"))},[t[32]||(t[32]=x("ΔECE ",-1)),S(C,{k:"ece_delta",sortKey:n(_),sortDir:n(y)},null,8,["sortKey","sortDir"])]),e("th",{class:"py-1 pr-4 cursor-pointer",onClick:t[10]||(t[10]=o=>n(f)("val_samples"))},[t[33]||(t[33]=x("ValSamples ",-1)),S(C,{k:"val_samples",sortKey:n(_),sortDir:n(y)},null,8,["sortKey","sortDir"])]),e("th",{class:"py-1 pr-4 cursor-pointer",onClick:t[11]||(t[11]=o=>n(f)("auc_ratio"))},[t[34]||(t[34]=x("ΔAUC Ratio ",-1)),S(C,{k:"auc_ratio",sortKey:n(_),sortDir:n(y)},null,8,["sortKey","sortDir"])]),e("th",{class:"py-1 pr-4 cursor-pointer",onClick:t[12]||(t[12]=o=>n(f)("ece_margin_ratio"))},[t[35]||(t[35]=x("ECE Margin ",-1)),S(C,{k:"ece_margin_ratio",sortKey:n(_),sortDir:n(y)},null,8,["sortKey","sortDir"])])])]),e("tbody",null,[(c(!0),d(et,null,ot(n(A),o=>(c(),d("tr",{key:o.id,class:"border-b border-neutral-800/40 hover:bg-neutral-800/30"},[e("td",ee,l(o.id||"—"),1),e("td",{class:"py-1 pr-4",title:o.created_at},l(s(o.created_at)),9,oe),e("td",se,[e("span",{class:W(a(o.decision))},l(o.decision),3)]),e("td",{class:"py-1 pr-4 max-w-[240px] truncate",title:o.reason||void 0},l(o.reason?String(o.reason):"—"),9,ne),e("td",re,[e("span",{class:W(["px-1.5 py-0.5 rounded text-[10px] font-medium",n(q)(o.reason_category)])},l(o.reason_category),3)]),e("td",ae,l(o.model_id||"—"),1),e("td",le,l(o.previous_production_model_id||"—"),1),e("td",ie,l(o.samples_old??"—"),1),e("td",ue,l(o.samples_new??"—"),1),e("td",{class:"py-1 pr-4 font-mono",title:o.auc_improve!=null?String(o.auc_improve):void 0},l(o.auc_improve!=null?o.auc_improve.toFixed(4):"—"),9,de),e("td",{class:"py-1 pr-4 font-mono",title:o.ece_delta!=null?String(o.ece_delta):void 0},l(o.ece_delta!=null?o.ece_delta.toFixed(4):"—"),9,ce),e("td",pe,l(o.val_samples!=null?o.val_samples:"—"),1),e("td",{class:W(["py-1 pr-4 font-mono",w(o.auc_ratio,!0)])},l(i(o.auc_ratio)),3),e("td",{class:W(["py-1 pr-4 font-mono",w(o.ece_margin_ratio,!1)])},l(i(o.ece_margin_ratio)),3)]))),128)),!n(M)&&n(A).length===0?(c(),d("tr",me,[...t[42]||(t[42]=[e("td",{colspan:"9",class:"py-4 text-center text-neutral-500"},"No events",-1)])])):O("",!0)])])])])]))}}),xe=vt(fe,[["__scopeId","data-v-7082da83"]]);export{xe as default};
