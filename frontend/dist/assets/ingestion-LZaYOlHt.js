import{j as H,k as l,c as n}from"./index-BtrOmqR2.js";import L from"./http-CilSfrpq.js";const U=H("ingestion",()=>{const a=l({}),o=l(null),r=l(!1),s=l([]),c=l(null),f=120,u=l(!0),v=l(5);let i=null,g=null;try{const t=localStorage.getItem("ingestion_status_cache_v1");if(t){const e=JSON.parse(t);e&&typeof e=="object"&&(e.status&&typeof e.status=="object"&&(a.value=e.status),typeof e.lastUpdated=="number"&&(o.value=e.lastUpdated),Array.isArray(e.lagHistory)&&(s.value=e.lagHistory.slice(-f)))}}catch{}const S=n(()=>a.value.last_message_ts?(Date.now()/1e3-a.value.last_message_ts).toFixed(1):"-"),w=n(()=>a.value.stale===!0),x=n(()=>{const t=s.value;if(t.length<2)return"";const e=100,b=24,z=Math.max(...t,1),A=e/(t.length-1);return t.map((D,y)=>`${y===0?"M":"L"}${(y*A).toFixed(1)},${(b-D/z*b).toFixed(1)}`).join(" ")}),h=n(()=>!a.value.batch_size||a.value.batch_size===0?0:Math.min(1,(a.value.buffer_size||0)/a.value.batch_size)),I=n(()=>h.value>.8?"bg-brand-danger":h.value>.5?"bg-amber-400":"bg-brand-accent"),F=n(()=>{const t=a.value.last_flush_ts;if(!t)return"n/a";const e=Date.now()/1e3-t;return e<2?"just now":e<60?e.toFixed(0)+"s":Math.floor(e/60)+"m"});function p(){if(typeof a.value.last_message_ts=="number"){const t=Number((Date.now()/1e3-a.value.last_message_ts).toFixed(1));isNaN(t)||(s.value.push(t),s.value.length>f&&s.value.shift())}}async function d(){if(!r.value)try{r.value=!0,c.value=null;const t=await L.get("/api/ingestion/status");a.value=t.data,o.value=Date.now(),p();try{localStorage.setItem("ingestion_status_cache_v1",JSON.stringify({status:a.value,lastUpdated:o.value,lagHistory:s.value.slice(-f)}))}catch{}}catch(t){console.warn("[ingestion] fetch failed",t),c.value=(t==null?void 0:t.message)||"fetch failed"}finally{r.value=!1}}function m(){_(),g&&clearInterval(g),g=setInterval(p,1e3),u.value&&(d(),i=setInterval(d,v.value*1e3))}function _(){i&&clearInterval(i),i=null}function j(t){v.value=t,m()}function N(t){typeof t=="boolean"?u.value=t:u.value=!u.value,m()}return{status:a,lastUpdated:o,loading:r,lagHistory:s,auto:u,intervalSec:v,error:c,lag:S,stale:w,sparkPath:x,bufferFillRatio:h,bufferBarClass:I,flushAgeLabel:F,fetchStatus:d,startPolling:m,stopPolling:_,setIntervalSec:j,toggleAuto:N}});export{U as u};
